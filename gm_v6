-- ============================================
-- ULTIMATE SKIBIDI GUI v8.0 - FIXED VERSION
-- All assets loading properly | Compact layout
-- Total stats tracking | Loading.webm background
-- ============================================

local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local CoreGui = game:GetService("CoreGui")
local SoundService = game:GetService("SoundService")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local HttpService = game:GetService("HttpService")

local GUI = {}
GUI.Config = {}
GUI.SkibidiGui = nil
GUI.MainFrame = nil
GUI.VideoBackground = nil
GUI.MusicSound = nil
GUI.Connections = {}
GUI.Tasks = {}
GUI.RunningTweens = {}
GUI.SessionStartTime = tick()
GUI._BoostScreen = nil
GUI.IsMinimized = false
GUI.IsPaused = false
GUI.IsMobile = false
GUI.IsTablet = false
GUI.ScreenSize = Vector2.new(0, 0)
GUI.PersistentData = nil
GUI.DownloadQueue = {}
GUI.DownloadProgress = {}

-- Enhanced color palette
GUI.Colors = {
    Background = Color3.fromRGB(6, 8, 15),
    Surface = Color3.fromRGB(12, 15, 25),
    SurfaceLight = Color3.fromRGB(20, 24, 38),
    Primary = Color3.fromRGB(88, 166, 255),
    PrimaryGlow = Color3.fromRGB(120, 190, 255),
    Success = Color3.fromRGB(52, 211, 153),
    Warning = Color3.fromRGB(251, 191, 36),
    Error = Color3.fromRGB(239, 68, 68),
    Text = Color3.fromRGB(255, 255, 255),
    TextMuted = Color3.fromRGB(156, 163, 175),
    Border = Color3.fromRGB(40, 48, 70),
    Overlay = Color3.fromRGB(0, 0, 0),
    Accent1 = Color3.fromRGB(168, 85, 247),
    Accent2 = Color3.fromRGB(236, 72, 153),
    Accent3 = Color3.fromRGB(34, 211, 238),
}

-- Z-INDEX LAYERS
GUI.ZLayers = {
    VideoBackground = 1000,
    MainGUI = 10000,
    Controls = 10100,
    LoadingScreen = 20000,
    ServerChange = 25000
}

-- Configuration
local WORKSPACE_FOLDER = "cuackerdoing"
local ASSETS_FOLDER = WORKSPACE_FOLDER .. "/assets"
local DATA_FILE = WORKSPACE_FOLDER .. "/persistent_data.json"
local MUSIC_TIME_FILE = WORKSPACE_FOLDER .. "/musictime.txt"
local ASSETS_REPO = "https://raw.githubusercontent.com/Ryu-Dev-here/assetsfora/main/"

-- Asset definitions - ALL ASSETS INCLUDING WEBM FILES
local ASSETS = {
    {name = "background.png", type = "video", size = 590000, priority = 1}, -- Right panel background (WebM supported)
    {name = "backlua.png", type = "image", size = 174000, priority = 1}, -- Left panel image
    {name = "boost.webm", type = "video", size = 16539000, priority = 2},
    {name = "change.webm", type = "video", size = 25266000, priority = 3},
    {name = "loading.webm", type = "video", size = 3748000, priority = 1}, -- LOADING VIDEO
    {name = "sound.mp3", type = "audio", size = 7949000, priority = 1},
}

GUI.Config = {
    AutoFarmEnabled = true,
    MusicEnabled = true,
    MusicVolume = 0.5,
    FastMode = false,
    VideoBackgrounds = true
}

-- ============================================
-- PERSISTENT STORAGE SYSTEM (IMPROVED)
-- ============================================

local PersistentStorage = {}

function PersistentStorage:Init()
    pcall(function()
        if makefolder and not isfolder(WORKSPACE_FOLDER) then
            makefolder(WORKSPACE_FOLDER)
        end
        if makefolder and not isfolder(ASSETS_FOLDER) then
            makefolder(ASSETS_FOLDER)
        end
    end)
end

function PersistentStorage:Load()
    local success, data = pcall(function()
        if not isfile or not readfile then return nil end
        if not isfile(DATA_FILE) then return nil end
        
        local content = readfile(DATA_FILE)
        return HttpService:JSONDecode(content)
    end)
    
    if success and data and type(data) == "table" then
        return data
    end
    
    return {
        -- TOTAL STATS (ALL TIME)
        totalBountyGained = 0,
        totalKills = 0,
        totalTimeSeconds = 0,
        
        -- Current session tracking
        currentSessionStart = os.time(),
        currentSessionBounty = 0,
        currentSessionKills = 0,
        currentSessionTime = 0,
        
        -- Historical data
        sessions = {},
        lifetimeStats = {
            totalSessions = 0,
            averageBountyPerSession = 0,
            averageKillsPerSession = 0,
            bestSession = {bounty = 0, kills = 0, time = 0}
        }
    }
end

function PersistentStorage:Save(data)
    pcall(function()
        if not writefile then return end
        
        local content = HttpService:JSONEncode(data)
        writefile(DATA_FILE, content)
    end)
end

function PersistentStorage:UpdateSession(bountyGain, kills, timeElapsed)
    local data = self:Load()
    
    -- Update TOTAL stats (this is what displays in GUI)
    data.totalBountyGained = (data.totalBountyGained or 0) + bountyGain
    data.totalKills = (data.totalKills or 0) + kills
    data.totalTimeSeconds = (data.totalTimeSeconds or 0) + timeElapsed
    
    -- Update current session
    data.currentSessionBounty = bountyGain
    data.currentSessionKills = kills
    data.currentSessionTime = timeElapsed
    
    -- Add to session history
    table.insert(data.sessions, {
        timestamp = os.time(),
        bounty = bountyGain,
        kills = kills,
        time = timeElapsed
    })
    
    -- Keep only last 100 sessions
    if #data.sessions > 100 then
        table.remove(data.sessions, 1)
    end
    
    -- Update lifetime stats
    data.lifetimeStats.totalSessions = #data.sessions
    if #data.sessions > 0 then
        local totalB, totalK = 0, 0
        for _, session in ipairs(data.sessions) do
            totalB = totalB + (session.bounty or 0)
            totalK = totalK + (session.kills or 0)
        end
        data.lifetimeStats.averageBountyPerSession = math.floor(totalB / #data.sessions)
        data.lifetimeStats.averageKillsPerSession = math.floor(totalK / #data.sessions)
    end
    
    -- Track best session
    if bountyGain > (data.lifetimeStats.bestSession.bounty or 0) then
        data.lifetimeStats.bestSession = {
            bounty = bountyGain,
            kills = kills,
            time = timeElapsed,
            timestamp = os.time()
        }
    end
    
    self:Save(data)
    return data
end

function PersistentStorage:GetStats()
    local data = self:Load()
    return {
        -- TOTAL STATS (WHAT GUI SHOWS)
        total_bounty = data.totalBountyGained or 0,
        total_kills = data.totalKills or 0,
        total_time = data.totalTimeSeconds or 0,
        
        -- Current session (for internal tracking)
        session_bounty = data.currentSessionBounty or 0,
        session_kills = data.currentSessionKills or 0,
        session_time = data.currentSessionTime or 0,
        
        lifetime = data.lifetimeStats or {}
    }
end

PersistentStorage:Init()
GUI.PersistentData = PersistentStorage:Load()

-- ============================================
-- DEVICE DETECTION
-- ============================================

local function DetectDevice()
    local viewportSize = workspace.CurrentCamera.ViewportSize
    GUI.ScreenSize = viewportSize
    
    if viewportSize.X < 600 or (UserInputService.TouchEnabled and not UserInputService.KeyboardEnabled and not UserInputService.GamepadEnabled) then
        GUI.IsMobile = true
        GUI.IsTablet = false
    elseif viewportSize.X >= 600 and viewportSize.X < 1024 and UserInputService.TouchEnabled then
        GUI.IsMobile = false
        GUI.IsTablet = true
    else
        GUI.IsMobile = false
        GUI.IsTablet = false
    end
end

local function GetResponsiveValue(desktopValue, mobileValue, tabletValue)
    if GUI.IsMobile then
        return mobileValue or (desktopValue * 0.6)
    elseif GUI.IsTablet then
        return tabletValue or (desktopValue * 0.8)
    else
        return desktopValue
    end
end

-- ============================================
-- HELPER FUNCTIONS
-- ============================================

function GUI.AddConnection(connection)
    if connection then
        table.insert(GUI.Connections, connection)
    end
    return connection
end

function GUI.AddTask(taskThread)
    if taskThread then
        table.insert(GUI.Tasks, taskThread)
    end
    return taskThread
end

local function Tween(object, properties, duration, style, direction, callback)
    if not object or not object.Parent then return nil end
    
    local success, tween = pcall(function()
        return TweenService:Create(
            object,
            TweenInfo.new(
                duration or 0.4,
                style or Enum.EasingStyle.Quart,
                direction or Enum.EasingDirection.Out
            ),
            properties
        )
    end)
    
    if not success or not tween then return nil end
    
    table.insert(GUI.RunningTweens, tween)
    
    tween.Completed:Connect(function()
        local index = table.find(GUI.RunningTweens, tween)
        if index then
            table.remove(GUI.RunningTweens, index)
        end
        if callback then callback() end
    end)
    
    pcall(function() tween:Play() end)
    return tween
end

-- ============================================
-- PREMIUM ICON SYSTEM (COMPACT)
-- ============================================

local Icons = {}

function Icons.Create(parent, iconType, size, color)
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(0, size, 0, size)
    frame.BackgroundTransparency = 1
    frame.Parent = parent
    
    local canvas = Instance.new("Frame")
    canvas.Size = UDim2.new(1, 0, 1, 0)
    canvas.BackgroundTransparency = 1
    canvas.Parent = frame
    
    color = color or GUI.Colors.Primary
    
    if iconType == "target" then
        local outerCircle = Instance.new("Frame")
        outerCircle.Size = UDim2.new(0.8, 0, 0.8, 0)
        outerCircle.Position = UDim2.new(0.1, 0, 0.1, 0)
        outerCircle.BackgroundTransparency = 1
        outerCircle.Parent = canvas
        
        local outerStroke = Instance.new("UIStroke")
        outerStroke.Color = color
        outerStroke.Thickness = 2
        outerStroke.Parent = outerCircle
        
        local outerCorner = Instance.new("UICorner")
        outerCorner.CornerRadius = UDim.new(1, 0)
        outerCorner.Parent = outerCircle
        
        local centerDot = Instance.new("Frame")
        centerDot.Size = UDim2.new(0.3, 0, 0.3, 0)
        centerDot.Position = UDim2.new(0.35, 0, 0.35, 0)
        centerDot.BackgroundColor3 = color
        centerDot.Parent = canvas
        
        local dotCorner = Instance.new("UICorner")
        dotCorner.CornerRadius = UDim.new(1, 0)
        dotCorner.Parent = centerDot
        
    elseif iconType == "status" then
        local center = Instance.new("Frame")
        center.Size = UDim2.new(0.4, 0, 0.4, 0)
        center.Position = UDim2.new(0.3, 0, 0.3, 0)
        center.BackgroundColor3 = color
        center.Parent = canvas
        
        local centerCorner = Instance.new("UICorner")
        centerCorner.CornerRadius = UDim.new(1, 0)
        centerCorner.Parent = center
        
    elseif iconType == "bounty" then
        local diamond = Instance.new("Frame")
        diamond.Size = UDim2.new(0.6, 0, 0.6, 0)
        diamond.Position = UDim2.new(0.2, 0, 0.2, 0)
        diamond.BackgroundColor3 = color
        diamond.Rotation = 45
        diamond.Parent = canvas
        
        local diamondCorner = Instance.new("UICorner")
        diamondCorner.CornerRadius = UDim.new(0.15, 0)
        diamondCorner.Parent = diamond
        
    elseif iconType == "time" then
        local clockFace = Instance.new("Frame")
        clockFace.Size = UDim2.new(0.9, 0, 0.9, 0)
        clockFace.Position = UDim2.new(0.05, 0, 0.05, 0)
        clockFace.BackgroundTransparency = 1
        clockFace.Parent = canvas
        
        local clockStroke = Instance.new("UIStroke")
        clockStroke.Color = color
        clockStroke.Thickness = 2
        clockStroke.Parent = clockFace
        
        local clockCorner = Instance.new("UICorner")
        clockCorner.CornerRadius = UDim.new(1, 0)
        clockCorner.Parent = clockFace
        
        local hourHand = Instance.new("Frame")
        hourHand.Size = UDim2.new(0, 2, 0.25, 0)
        hourHand.Position = UDim2.new(0.5, -1, 0.5, 0)
        hourHand.AnchorPoint = Vector2.new(0.5, 1)
        hourHand.BackgroundColor3 = color
        hourHand.Rotation = 45
        hourHand.Parent = canvas
        
        local hourCorner = Instance.new("UICorner")
        hourCorner.CornerRadius = UDim.new(1, 0)
        hourCorner.Parent = hourHand
        
        local minuteHand = Instance.new("Frame")
        minuteHand.Size = UDim2.new(0, 1.5, 0.35, 0)
        minuteHand.Position = UDim2.new(0.5, -0.75, 0.5, 0)
        minuteHand.AnchorPoint = Vector2.new(0.5, 1)
        minuteHand.BackgroundColor3 = color
        minuteHand.Rotation = 135
        minuteHand.Parent = canvas
        
        local minuteCorner = Instance.new("UICorner")
        minuteCorner.CornerRadius = UDim.new(1, 0)
        minuteCorner.Parent = minuteHand
    end
    
    return frame
end

-- ============================================
-- ASSET DOWNLOADING SYSTEM
-- ============================================

local AssetDownloader = {}

function AssetDownloader:DownloadAsset(asset, onProgress)
    return GUI.AddTask(task.spawn(function()
        pcall(function()
            if not game.HttpGet then return end
            if not writefile then return end
            
            local path = ASSETS_FOLDER .. "/" .. asset.name
            
            -- Check if already exists
            if isfile and isfile(path) then
                if onProgress then
                    onProgress(asset.name, 1, asset.size, "cached")
                end
                task.wait(0.1) -- Small delay for UI update
                return path
            end
            
            -- Download with progress simulation
            local success, data = pcall(function()
                if onProgress then
                    onProgress(asset.name, 0.1, asset.size, "downloading")
                end
                
                local content = game:HttpGet(ASSETS_REPO .. asset.name, true)
                
                if onProgress then
                    onProgress(asset.name, 0.8, asset.size, "writing")
                end
                
                writefile(path, content)
                
                if onProgress then
                    onProgress(asset.name, 1, asset.size, "complete")
                end
                
                task.wait(0.1) -- Small delay for UI update
                return path
            end)
            
            if success and data then
                return data
            else
                if onProgress then
                    onProgress(asset.name, 0, asset.size, "failed")
                end
            end
        end)
    end))
end

function AssetDownloader:LoadAsset(assetPath, targetObject)
    pcall(function()
        local asset = getcustomasset or getsynasset
        if not asset then return end
        if not isfile or not isfile(assetPath) then return end
        
        local assetUrl = asset(assetPath)
        
        if targetObject:IsA("ImageLabel") or targetObject:IsA("ImageButton") then
            targetObject.Image = assetUrl
        elseif targetObject:IsA("VideoFrame") then
            targetObject.Video = assetUrl
        elseif targetObject:IsA("Sound") then
            targetObject.SoundId = assetUrl
        end
    end)
end

-- ============================================
-- LOADING SCREEN WITH LOADING.WEBM BACKGROUND
-- ============================================

function GUI.CreateAdvancedLoader()
    local loaderWidth = GetResponsiveValue(700, 380, 520)
    local loaderHeight = GetResponsiveValue(500, 320, 400)
    
    local LoaderScreen = Instance.new("Frame")
    LoaderScreen.Name = "AdvancedLoader"
    LoaderScreen.Size = UDim2.new(1, 0, 1, 0)
    LoaderScreen.BackgroundColor3 = GUI.Colors.Background
    LoaderScreen.BackgroundTransparency = 0
    LoaderScreen.ZIndex = GUI.ZLayers.LoadingScreen
    LoaderScreen.Parent = GUI.SkibidiGui
    
    -- LOADING.WEBM AS BACKGROUND (FULLSCREEN LEFT SIDE)
    local LoadingVideo = Instance.new("VideoFrame")
    LoadingVideo.Size = UDim2.new(0.5, 0, 1, 0) -- LEFT HALF OF SCREEN
    LoadingVideo.Position = UDim2.new(0, 0, 0, 0)
    LoadingVideo.BackgroundTransparency = 1
    LoadingVideo.Looped = true
    LoadingVideo.Volume = 0
    LoadingVideo.ZIndex = GUI.ZLayers.LoadingScreen
    LoadingVideo.Parent = LoaderScreen
    
    -- Dark overlay on right side
    local RightOverlay = Instance.new("Frame")
    RightOverlay.Size = UDim2.new(0.5, 0, 1, 0)
    RightOverlay.Position = UDim2.new(0.5, 0, 0, 0)
    RightOverlay.BackgroundColor3 = GUI.Colors.Background
    RightOverlay.BorderSizePixel = 0
    RightOverlay.ZIndex = GUI.ZLayers.LoadingScreen
    RightOverlay.Parent = LoaderScreen
    
    -- Gradient overlay for blend
    local BlendOverlay = Instance.new("Frame")
    BlendOverlay.Size = UDim2.new(1, 0, 1, 0)
    BlendOverlay.BackgroundTransparency = 1
    BlendOverlay.ZIndex = GUI.ZLayers.LoadingScreen + 1
    BlendOverlay.Parent = LoaderScreen
    
    local gradient = Instance.new("UIGradient")
    gradient.Color = ColorSequence.new{
        ColorSequenceKeypoint.new(0, Color3.fromRGB(0, 0, 0)),
        ColorSequenceKeypoint.new(0.5, GUI.Colors.Background),
        ColorSequenceKeypoint.new(1, GUI.Colors.Background)
    }
    gradient.Rotation = 0
    gradient.Transparency = NumberSequence.new{
        NumberSequenceKeypoint.new(0, 0.6),
        NumberSequenceKeypoint.new(0.5, 0),
        NumberSequenceKeypoint.new(1, 0)
    }
    gradient.Parent = BlendOverlay
    
    -- Main container (centered)
    local Container = Instance.new("Frame")
    Container.Size = UDim2.new(0, loaderWidth, 0, loaderHeight)
    Container.Position = UDim2.new(0.5, -loaderWidth/2, 0.5, -loaderHeight/2)
    Container.BackgroundTransparency = 1
    Container.ZIndex = GUI.ZLayers.LoadingScreen + 2
    Container.Parent = LoaderScreen
    
    -- Logo
    local logoSize = GetResponsiveValue(62, 44, 52)
    local Logo = Instance.new("TextLabel")
    Logo.Text = "SKIBIDI"
    Logo.Size = UDim2.new(1, 0, 0, logoSize + 18)
    Logo.BackgroundTransparency = 1
    Logo.Font = Enum.Font.GothamBold
    Logo.TextColor3 = GUI.Colors.Text
    Logo.TextSize = logoSize
    Logo.TextTransparency = 1
    Logo.ZIndex = GUI.ZLayers.LoadingScreen + 3
    Logo.Parent = Container
    
    -- Version badge
    local badgeSize = GetResponsiveValue(14, 11, 12)
    local VersionBadge = Instance.new("TextLabel")
    VersionBadge.Text = "v8.0 ULTIMATE FIXED"
    VersionBadge.Size = UDim2.new(1, 0, 0, badgeSize + 14)
    VersionBadge.Position = UDim2.new(0, 0, 0, logoSize + 26)
    VersionBadge.BackgroundTransparency = 1
    VersionBadge.Font = Enum.Font.GothamMedium
    VersionBadge.TextColor3 = GUI.Colors.Primary
    VersionBadge.TextSize = badgeSize
    VersionBadge.TextTransparency = 1
    VersionBadge.ZIndex = GUI.ZLayers.LoadingScreen + 3
    VersionBadge.Parent = Container
    
    -- Overall progress
    local progressY = GetResponsiveValue(160, 130, 145)
    local ProgressBar = Instance.new("Frame")
    ProgressBar.Size = UDim2.new(1, -40, 0, 6)
    ProgressBar.Position = UDim2.new(0, 20, 0, progressY)
    ProgressBar.BackgroundColor3 = GUI.Colors.Surface
    ProgressBar.BorderSizePixel = 0
    ProgressBar.BackgroundTransparency = 1
    ProgressBar.ZIndex = GUI.ZLayers.LoadingScreen + 3
    ProgressBar.Parent = Container
    
    local ProgressCorner = Instance.new("UICorner")
    ProgressCorner.CornerRadius = UDim.new(1, 0)
    ProgressCorner.Parent = ProgressBar
    
    local Progress = Instance.new("Frame")
    Progress.Size = UDim2.new(0, 0, 1, 0)
    Progress.BackgroundColor3 = GUI.Colors.Primary
    Progress.BorderSizePixel = 0
    Progress.ZIndex = GUI.ZLayers.LoadingScreen + 4
    Progress.Parent = ProgressBar
    
    local ProgressCorner2 = Instance.new("UICorner")
    ProgressCorner2.CornerRadius = UDim.new(1, 0)
    ProgressCorner2.Parent = Progress
    
    -- Status text
    local statusSize = GetResponsiveValue(15, 11, 13)
    local StatusText = Instance.new("TextLabel")
    StatusText.Text = "Initializing..."
    StatusText.Size = UDim2.new(1, -40, 0, statusSize + 8)
    StatusText.Position = UDim2.new(0, 20, 0, progressY + 26)
    StatusText.BackgroundTransparency = 1
    StatusText.Font = Enum.Font.GothamMedium
    StatusText.TextColor3 = GUI.Colors.TextMuted
    StatusText.TextSize = statusSize
    StatusText.TextTransparency = 1
    StatusText.TextXAlignment = Enum.TextXAlignment.Left
    StatusText.ZIndex = GUI.ZLayers.LoadingScreen + 3
    StatusText.Parent = Container
    
    -- Percentage
    local percentSize = GetResponsiveValue(42, 28, 35)
    local PercentText = Instance.new("TextLabel")
    PercentText.Text = "0%"
    PercentText.Size = UDim2.new(1, -40, 0, percentSize + 8)
    PercentText.Position = UDim2.new(0, 20, 0, progressY + 52)
    PercentText.BackgroundTransparency = 1
    PercentText.Font = Enum.Font.GothamBold
    PercentText.TextColor3 = GUI.Colors.Primary
    PercentText.TextSize = percentSize
    PercentText.TextTransparency = 1
    PercentText.TextXAlignment = Enum.TextXAlignment.Left
    PercentText.ZIndex = GUI.ZLayers.LoadingScreen + 3
    PercentText.Parent = Container
    
    -- Download details container
    local detailsY = progressY + 110
    local DetailsContainer = Instance.new("ScrollingFrame")
    DetailsContainer.Size = UDim2.new(1, -40, 0, 140)
    DetailsContainer.Position = UDim2.new(0, 20, 0, detailsY)
    DetailsContainer.BackgroundTransparency = 1
    DetailsContainer.ScrollBarThickness = 4
    DetailsContainer.ScrollBarImageColor3 = GUI.Colors.Primary
    DetailsContainer.CanvasSize = UDim2.new(0, 0, 0, 0)
    DetailsContainer.AutomaticCanvasSize = Enum.AutomaticSize.Y
    DetailsContainer.ZIndex = GUI.ZLayers.LoadingScreen + 3
    DetailsContainer.Parent = Container
    
    local DetailsLayout = Instance.new("UIListLayout")
    DetailsLayout.SortOrder = Enum.SortOrder.LayoutOrder
    DetailsLayout.Padding = UDim.new(0, 6)
    DetailsLayout.Parent = DetailsContainer
    
    -- Entrance animations
    Tween(Logo, {TextTransparency = 0}, 0.8)
    task.wait(0.2)
    Tween(VersionBadge, {TextTransparency = 0}, 0.8)
    task.wait(0.2)
    Tween(ProgressBar, {BackgroundTransparency = 0.5}, 0.8)
    Tween(StatusText, {TextTransparency = 0}, 0.8)
    Tween(PercentText, {TextTransparency = 0}, 0.8)
    
    local downloadItems = {}
    
    return {
        Screen = LoaderScreen,
        Progress = Progress,
        Status = StatusText,
        Percent = PercentText,
        Details = DetailsContainer,
        LoadingVideo = LoadingVideo,
        
        AddDownloadItem = function(assetName)
            local itemSize = GetResponsiveValue(12, 9, 10)
            local Item = Instance.new("Frame")
            Item.Size = UDim2.new(1, 0, 0, itemSize + 10)
            Item.BackgroundColor3 = GUI.Colors.SurfaceLight
            Item.BorderSizePixel = 0
            Item.ZIndex = GUI.ZLayers.LoadingScreen + 4
            Item.Parent = DetailsContainer
            
            local ItemCorner = Instance.new("UICorner")
            ItemCorner.CornerRadius = UDim.new(0, 5)
            ItemCorner.Parent = Item
            
            local NameLabel = Instance.new("TextLabel")
            NameLabel.Text = assetName
            NameLabel.Size = UDim2.new(0.6, -8, 1, 0)
            NameLabel.Position = UDim2.new(0, 8, 0, 0)
            NameLabel.BackgroundTransparency = 1
            NameLabel.Font = Enum.Font.GothamMedium
            NameLabel.TextColor3 = GUI.Colors.Text
            NameLabel.TextSize = itemSize
            NameLabel.TextXAlignment = Enum.TextXAlignment.Left
            NameLabel.TextTruncate = Enum.TextTruncate.AtEnd
            NameLabel.ZIndex = GUI.ZLayers.LoadingScreen + 5
            NameLabel.Parent = Item
            
            local StatusLabel = Instance.new("TextLabel")
            StatusLabel.Text = "Waiting..."
            StatusLabel.Size = UDim2.new(0.4, -8, 1, 0)
            StatusLabel.Position = UDim2.new(0.6, 0, 0, 0)
            StatusLabel.BackgroundTransparency = 1
            StatusLabel.Font = Enum.Font.Gotham
            StatusLabel.TextColor3 = GUI.Colors.TextMuted
            StatusLabel.TextSize = itemSize - 1
            StatusLabel.TextXAlignment = Enum.TextXAlignment.Right
            StatusLabel.ZIndex = GUI.ZLayers.LoadingScreen + 5
            StatusLabel.Parent = Item
            
            downloadItems[assetName] = {
                Frame = Item,
                Status = StatusLabel
            }
            
            return Item
        end,
        
        UpdateDownloadItem = function(assetName, progress, size, status)
            if downloadItems[assetName] then
                local statusText = ""
                local color = GUI.Colors.TextMuted
                
                if status == "downloading" then
                    statusText = string.format("%.0f%%", progress * 100)
                    color = GUI.Colors.Primary
                elseif status == "complete" then
                    statusText = "✓ Complete"
                    color = GUI.Colors.Success
                elseif status == "cached" then
                    statusText = "✓ Cached"
                    color = GUI.Colors.Success
                elseif status == "failed" then
                    statusText = "✗ Failed"
                    color = GUI.Colors.Error
                else
                    statusText = status
                end
                
                downloadItems[assetName].Status.Text = statusText
                downloadItems[assetName].Status.TextColor3 = color
            end
        end,
        
        Update = function(progress, statusText)
            if StatusText and StatusText.Parent then
                StatusText.Text = statusText or "Loading..."
            end
            if PercentText and PercentText.Parent then
                PercentText.Text = math.floor(progress * 100) .. "%"
            end
            if Progress and Progress.Parent then
                Tween(Progress, {Size = UDim2.new(progress, 0, 1, 0)}, 0.3)
            end
        end,
        
        Complete = function()
            if not LoaderScreen or not LoaderScreen.Parent then return end
            
            if StatusText then StatusText.Text = "Ready!" end
            if PercentText then PercentText.Text = "100%" end
            
            task.wait(0.8)
            
            Tween(LoaderScreen, {BackgroundTransparency = 1}, 1)
            
            for _, child in pairs(LoaderScreen:GetDescendants()) do
                if child:IsA("TextLabel") or child:IsA("Frame") or child:IsA("VideoFrame") then
                    pcall(function()
                        if child.TextTransparency then
                            Tween(child, {TextTransparency = 1, BackgroundTransparency = 1}, 1)
                        else
                            Tween(child, {BackgroundTransparency = 1}, 1)
                        end
                    end)
                end
            end
            
            task.wait(1.2)
            
            if LoaderScreen and LoaderScreen.Parent then
                LoaderScreen:Destroy()
            end
        end
    }
end

-- ============================================
-- ASSET INITIALIZATION WITH LIVE PROGRESS
-- ============================================

function GUI.InitAssets()
    local loader = GUI.CreateAdvancedLoader()
    if not loader then return end
    
    loader.Update(0.05, "Creating workspace...")
    
    PersistentStorage:Init()
    
    task.wait(0.3)
    loader.Update(0.1, "Preparing downloads...")
    
    -- Sort assets by priority
    table.sort(ASSETS, function(a, b)
        return (a.priority or 99) < (b.priority or 99)
    end)
    
    -- Add download items to UI
    for _, asset in ipairs(ASSETS) do
        loader.AddDownloadItem(asset.name)
    end
    
    task.wait(0.2)
    
    -- LOAD LOADING.WEBM FIRST
    local loadingVideoPath = ASSETS_FOLDER .. "/loading.webm"
    local loadingAsset = nil
    for _, asset in ipairs(ASSETS) do
        if asset.name == "loading.webm" then
            loadingAsset = asset
            break
        end
    end
    
    if loadingAsset then
        loader.Update(0.12, "Loading background video...")
        AssetDownloader:DownloadAsset(loadingAsset, function(name, progress, size, status)
            loader.UpdateDownloadItem(name, progress, size, status)
            
            if (status == "complete" or status == "cached") and loader.LoadingVideo then
                -- Load the video into the VideoFrame
                AssetDownloader:LoadAsset(loadingVideoPath, loader.LoadingVideo)
                loader.LoadingVideo:Play()
            end
        end)
        task.wait(0.5)
    end
    
    -- Download remaining assets with progress
    local totalSize = 0
    local downloadedSize = 0
    local completedDownloads = 0
    
    for _, asset in ipairs(ASSETS) do
        totalSize = totalSize + asset.size
    end
    
    local downloadsToWaitFor = {}
    
    for i, asset in ipairs(ASSETS) do
        if asset.name == "loading.webm" then continue end -- Already loaded
        
        loader.Update(0.15 + (i - 1) * 0.6 / #ASSETS, "Downloading " .. asset.name .. "...")
        
        local downloadTask = AssetDownloader:DownloadAsset(asset, function(name, progress, size, status)
            loader.UpdateDownloadItem(name, progress, size, status)
            
            if status == "complete" or status == "cached" then
                downloadedSize = downloadedSize + size
                completedDownloads = completedDownloads + 1
                local totalProgress = 0.15 + (downloadedSize / totalSize) * 0.6
                loader.Update(totalProgress, "Downloaded " .. name)
            end
        end)
        
        table.insert(downloadsToWaitFor, {name = asset.name, task = downloadTask})
    end
    
    -- WAIT FOR ALL DOWNLOADS TO COMPLETE
    loader.Update(0.8, "Waiting for all downloads...")
    local maxWaitTime = 60 -- 60 seconds max wait
    local waitStartTime = tick()
    
    while completedDownloads < (#ASSETS - 1) and (tick() - waitStartTime) < maxWaitTime do
        task.wait(0.1)
    end
    
    if completedDownloads < (#ASSETS - 1) then
        loader.Update(0.85, "Some downloads incomplete, continuing...")
    else
        loader.Update(0.85, "All downloads complete!")
    end
    
    task.wait(0.5)
    
    loader.Update(0.92, "Loading audio...")
    
    -- Initialize music
    pcall(function()
        GUI.MusicSound = Instance.new("Sound")
        GUI.MusicSound.Name = "SkibidiMusic"
        GUI.MusicSound.Looped = true
        GUI.MusicSound.Volume = GUI.Config.MusicVolume
        GUI.MusicSound.Parent = SoundService
        
        local musicPath = ASSETS_FOLDER .. "/sound.mp3"
        if isfile and isfile(musicPath) then
            AssetDownloader:LoadAsset(musicPath, GUI.MusicSound)
            
            -- Load saved position
            if isfile and isfile(MUSIC_TIME_FILE) and readfile then
                local savedTime = tonumber(readfile(MUSIC_TIME_FILE))
                if savedTime and savedTime > 0 then
                    GUI.MusicSound.TimePosition = savedTime
                end
            end
            
            GUI.MusicSound:Play()
        end
    end)
    
    task.wait(0.5)
    loader.Update(0.98, "Complete! Loading GUI...")
    
    task.wait(0.5)
    loader.Update(1, "Ready!")
    task.wait(0.8)
    loader.Complete()
    
    -- Save music time on teleport
    local teleportConnection = Players.LocalPlayer.OnTeleport:Connect(function()
        GUI.SaveMusicState()
    end)
    GUI.AddConnection(teleportConnection)
end

-- ============================================
-- MUSIC STATE MANAGEMENT
-- ============================================

function GUI.SaveMusicState()
    if not GUI.MusicSound then return end
    
    pcall(function()
        if GUI.MusicSound.IsPlaying and writefile then
            local timePos = GUI.MusicSound.TimePosition
            if timePos and type(timePos) == "number" and timePos > 0 then
                writefile(MUSIC_TIME_FILE, tostring(timePos))
            end
        end
    end)
end

-- ============================================
-- MAIN GUI CREATION (COMPACT VERSION)
-- ============================================

function GUI.CreateMainGUI()
    if GUI.SkibidiGui then
        GUI.Cleanup()
    end
    
    local lp = Players.LocalPlayer
    if not lp then return nil end
    
    DetectDevice()
    
    local GUIVars = {}
    
    -- Create ScreenGui
    GUI.SkibidiGui = Instance.new("ScreenGui")
    GUI.SkibidiGui.Name = "SkibidiGui"
    GUI.SkibidiGui.ResetOnSpawn = false
    GUI.SkibidiGui.IgnoreGuiInset = true
    GUI.SkibidiGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    
    local guiParented = pcall(function()
        GUI.SkibidiGui.Parent = CoreGui
    end)
    
    if not guiParented or not GUI.SkibidiGui.Parent then
        local playerGui = lp:WaitForChild("PlayerGui", 5)
        if playerGui then
            GUI.SkibidiGui.Parent = playerGui
        else
            return nil
        end
    end
    
    -- COMPACT dimensions - DUAL PANEL RESTORED
    local mainWidth, mainHeight, leftPanelWidth, rightPanelWidth
    
    if GUI.IsMobile then
        -- Mobile: Single column (hide image panel)
        mainWidth = math.min(GUI.ScreenSize.X * 0.95, 360)
        mainHeight = math.min(GUI.ScreenSize.Y * 0.7, 480)
        leftPanelWidth = 0
        rightPanelWidth = mainWidth
    elseif GUI.IsTablet then
        -- Tablet: Compact dual panel
        mainWidth = math.min(GUI.ScreenSize.X * 0.85, 650)
        mainHeight = math.min(GUI.ScreenSize.Y * 0.65, 420)
        leftPanelWidth = math.floor(mainWidth * 0.35)
        rightPanelWidth = mainWidth - leftPanelWidth
    else
        -- Desktop: Compact dual panel
        mainWidth = 800 -- Reduced but still dual
        mainHeight = 480 -- Compact
        leftPanelWidth = 320 -- Left image panel
        rightPanelWidth = 480 -- Right stats panel
    end
    
    local cornerRadius = GetResponsiveValue(14, 12, 13)
    local controlBarHeight = GetResponsiveValue(38, 34, 36)
    
    -- Main GUI Frame (COMPACT SINGLE PANEL)
    GUI.MainFrame = Instance.new("Frame")
    GUI.MainFrame.Name = "MainFrame"
    GUI.MainFrame.BackgroundColor3 = GUI.Colors.Background
    GUI.MainFrame.BackgroundTransparency = 0.1
    GUI.MainFrame.Position = UDim2.new(0.5, -mainWidth/2, 0.5, -mainHeight/2)
    GUI.MainFrame.Size = UDim2.new(0, 0, 0, 0)
    GUI.MainFrame.BorderSizePixel = 0
    GUI.MainFrame.ClipsDescendants = true
    GUI.MainFrame.ZIndex = GUI.ZLayers.MainGUI
    GUI.MainFrame.Parent = GUI.SkibidiGui
    
    local MainCorner = Instance.new("UICorner")
    MainCorner.CornerRadius = UDim.new(0, cornerRadius)
    MainCorner.Parent = GUI.MainFrame
    
    local MainStroke = Instance.new("UIStroke")
    MainStroke.Color = GUI.Colors.Primary
    MainStroke.Thickness = 1.5
    MainStroke.Transparency = 0.3
    MainStroke.Parent = GUI.MainFrame
    
    -- Controls Bar
    local ControlsBar = Instance.new("Frame")
    ControlsBar.Name = "ControlsBar"
    ControlsBar.Size = UDim2.new(1, 0, 0, controlBarHeight)
    ControlsBar.BackgroundColor3 = GUI.Colors.Surface
    ControlsBar.BorderSizePixel = 0
    ControlsBar.ZIndex = GUI.ZLayers.Controls
    ControlsBar.Parent = GUI.MainFrame
    
    local ControlsCorner = Instance.new("UICorner")
    ControlsCorner.CornerRadius = UDim.new(0, cornerRadius)
    ControlsCorner.Parent = ControlsBar
    
    local ControlsMask = Instance.new("Frame")
    ControlsMask.Size = UDim2.new(1, 0, 0, cornerRadius + 5)
    ControlsMask.Position = UDim2.new(0, 0, 1, -(cornerRadius + 5))
    ControlsMask.BackgroundColor3 = GUI.Colors.Surface
    ControlsMask.BorderSizePixel = 0
    ControlsMask.ZIndex = GUI.ZLayers.Controls
    ControlsMask.Parent = ControlsBar
    
    -- Control Buttons (Compact)
    local buttonSize = GetResponsiveValue(12, 10, 11)
    local buttonSpacing = GetResponsiveValue(18, 16, 17)
    local buttonStartX = GetResponsiveValue(14, 11, 12)
    
    local function CreateControlButton(color, position, onClick)
        local btn = Instance.new("TextButton")
        btn.Size = UDim2.new(0, buttonSize, 0, buttonSize)
        btn.Position = UDim2.new(0, buttonStartX + (position * buttonSpacing), 0.5, -buttonSize/2)
        btn.BackgroundColor3 = color
        btn.BorderSizePixel = 0
        btn.Text = ""
        btn.AutoButtonColor = false
        btn.ZIndex = GUI.ZLayers.Controls + 1
        btn.Parent = ControlsBar
        
        local corner = Instance.new("UICorner")
        corner.CornerRadius = UDim.new(1, 0)
        corner.Parent = btn
        
        local stroke = Instance.new("UIStroke")
        stroke.Color = Color3.fromRGB(255, 255, 255)
        stroke.Thickness = 1
        stroke.Transparency = 0.8
        stroke.Parent = btn
        
        btn.MouseEnter:Connect(function()
            Tween(btn, {Size = UDim2.new(0, buttonSize + 2, 0, buttonSize + 2)}, 0.15)
            Tween(stroke, {Transparency = 0.3}, 0.15)
        end)
        
        btn.MouseLeave:Connect(function()
            Tween(btn, {Size = UDim2.new(0, buttonSize, 0, buttonSize)}, 0.15)
            Tween(stroke, {Transparency = 0.8}, 0.15)
        end)
        
        btn.MouseButton1Click:Connect(onClick)
        
        return btn
    end
    
    -- Close button
    CreateControlButton(Color3.fromRGB(255, 95, 86), 0, function()
        GUI.Cleanup()
        if getgenv()._SkibidiShuttingDown ~= nil then
            getgenv()._SkibidiShuttingDown = true
        end
    end)
    
    -- Pause button
    CreateControlButton(Color3.fromRGB(255, 189, 46), 1, function()
        GUI.IsPaused = not GUI.IsPaused
        
        if GUI.IsPaused then
            if getgenv().AutoFarmEnabled ~= nil then
                getgenv().AutoFarmEnabled = false
            end
            if GUIVars.StateValue then
                GUIVars.StateValue.Text = "PAUSED"
                GUIVars.StateValue.TextColor3 = GUI.Colors.Warning
            end
        else
            if getgenv().AutoFarmEnabled ~= nil then
                getgenv().AutoFarmEnabled = true
            end
            if GUIVars.StateValue then
                GUIVars.StateValue.TextColor3 = GUI.Colors.Text
            end
        end
    end)
    
    -- Minimize button
    local minWidth = GetResponsiveValue(200, 160, 180)
    CreateControlButton(Color3.fromRGB(39, 201, 63), 2, function()
        GUI.IsMinimized = not GUI.IsMinimized
        
        if GUI.IsMinimized then
            Tween(GUI.MainFrame, {Size = UDim2.new(0, minWidth, 0, controlBarHeight)}, 0.4, Enum.EasingStyle.Quart)
        else
            Tween(GUI.MainFrame, {Size = UDim2.new(0, mainWidth, 0, mainHeight)}, 0.4, Enum.EasingStyle.Quart)
        end
    end)
    
    -- Title (Compact)
    local titleSize = GetResponsiveValue(13, 10, 11)
    local TitleLabel = Instance.new("TextLabel")
    TitleLabel.Text = "SKIBIDI v8.0 FIXED"
    TitleLabel.Size = UDim2.new(1, -90, 1, 0)
    TitleLabel.Position = UDim2.new(0, buttonStartX + (3 * buttonSpacing) + 8, 0, 0)
    TitleLabel.BackgroundTransparency = 1
    TitleLabel.Font = Enum.Font.GothamBold
    TitleLabel.TextSize = titleSize
    TitleLabel.TextColor3 = GUI.Colors.Text
    TitleLabel.TextXAlignment = Enum.TextXAlignment.Left
    TitleLabel.ZIndex = GUI.ZLayers.Controls + 1
    TitleLabel.Parent = ControlsBar
    
    -- ============================================
    -- LEFT PANEL - BACKGROUND.PNG (primary) or BACKLUA.PNG (fallback)
    -- ============================================
    
    if leftPanelWidth > 0 then
        local LeftPanel = Instance.new("Frame")
        LeftPanel.Name = "LeftPanel"
        LeftPanel.Size = UDim2.new(0, leftPanelWidth, 1, -controlBarHeight)
        LeftPanel.Position = UDim2.new(0, 0, 0, controlBarHeight)
        LeftPanel.BackgroundTransparency = 1
        LeftPanel.BorderSizePixel = 0
        LeftPanel.ClipsDescendants = true
        LeftPanel.ZIndex = GUI.ZLayers.MainGUI
        LeftPanel.Parent = GUI.MainFrame
        
        -- Try BACKGROUND.PNG first (WebM support), fallback to BACKLUA.PNG
        local bgPath = ASSETS_FOLDER .. "/background.png"
        local backluaPath = ASSETS_FOLDER .. "/backlua.png"
        local imageLoaded = false
        
        -- Try background.png first (supports WebM renamed as .png)
        if isfile and isfile(bgPath) then
            -- Try as VideoFrame first (WebM support)
            local videoSuccess = pcall(function()
                local BgVideo = Instance.new("VideoFrame")
                BgVideo.Size = UDim2.new(1, 0, 1, 0)
                BgVideo.BackgroundTransparency = 1
                BgVideo.Looped = true
                BgVideo.Volume = 0
                BgVideo.ZIndex = GUI.ZLayers.MainGUI
                BgVideo.Parent = LeftPanel
                
                AssetDownloader:LoadAsset(bgPath, BgVideo)
                BgVideo:Play()
                imageLoaded = true
            end)
            
            -- Try as ImageLabel if WebM failed
            if not videoSuccess then
                pcall(function()
                    local BgImage = Instance.new("ImageLabel")
                    BgImage.Size = UDim2.new(1, 0, 1, 0)
                    BgImage.BackgroundTransparency = 1
                    BgImage.ScaleType = Enum.ScaleType.Crop
                    BgImage.ZIndex = GUI.ZLayers.MainGUI
                    BgImage.Parent = LeftPanel
                    
                    AssetDownloader:LoadAsset(bgPath, BgImage)
                    imageLoaded = true
                end)
            end
        end
        
        -- Fallback to backlua.png if background.png not loaded
        if not imageLoaded and isfile and isfile(backluaPath) then
            pcall(function()
                local BackgroundImage = Instance.new("ImageLabel")
                BackgroundImage.Size = UDim2.new(1, 0, 1, 0)
                BackgroundImage.BackgroundTransparency = 1
                BackgroundImage.ScaleType = Enum.ScaleType.Crop
                BackgroundImage.ImageTransparency = 0
                BackgroundImage.ZIndex = GUI.ZLayers.MainGUI
                BackgroundImage.Parent = LeftPanel
                
                AssetDownloader:LoadAsset(backluaPath, BackgroundImage)
            end)
        end
        
        -- Gradient overlay for depth
        local ImageOverlay = Instance.new("Frame")
        ImageOverlay.Size = UDim2.new(1, 0, 1, 0)
        ImageOverlay.BackgroundColor3 = GUI.Colors.Overlay
        ImageOverlay.BackgroundTransparency = 0.3
        ImageOverlay.BorderSizePixel = 0
        ImageOverlay.ZIndex = GUI.ZLayers.MainGUI + 1
        ImageOverlay.Parent = LeftPanel
        
        local OverlayGradient = Instance.new("UIGradient")
        OverlayGradient.Color = ColorSequence.new{
            ColorSequenceKeypoint.new(0, Color3.fromRGB(0, 0, 0)),
            ColorSequenceKeypoint.new(1, GUI.Colors.Background)
        }
        OverlayGradient.Rotation = 90
        OverlayGradient.Transparency = NumberSequence.new{
            NumberSequenceKeypoint.new(0, 0.4),
            NumberSequenceKeypoint.new(1, 0)
        }
        OverlayGradient.Parent = ImageOverlay
        
        -- Logo at bottom
        local logoSize = GetResponsiveValue(42, 32, 38)
        local LeftLogo = Instance.new("TextLabel")
        LeftLogo.Text = "SKIBIDI"
        LeftLogo.Size = UDim2.new(1, -16, 0, logoSize + 16)
        LeftLogo.Position = UDim2.new(0, 8, 1, -(logoSize + 24))
        LeftLogo.BackgroundTransparency = 1
        LeftLogo.Font = Enum.Font.GothamBold
        LeftLogo.TextColor3 = GUI.Colors.Text
        LeftLogo.TextSize = logoSize
        LeftLogo.TextXAlignment = Enum.TextXAlignment.Left
        LeftLogo.ZIndex = GUI.ZLayers.MainGUI + 2
        LeftLogo.Parent = LeftPanel
        
        -- Version badge
        local badgeWidth = GetResponsiveValue(75, 60, 68)
        local badgeHeight = GetResponsiveValue(28, 24, 26)
        local VersionBadge = Instance.new("Frame")
        VersionBadge.Size = UDim2.new(0, badgeWidth, 0, badgeHeight)
        VersionBadge.Position = UDim2.new(0, 8, 0, 8)
        VersionBadge.BackgroundColor3 = GUI.Colors.Primary
        VersionBadge.BackgroundTransparency = 0
        VersionBadge.BorderSizePixel = 0
        VersionBadge.ZIndex = GUI.ZLayers.MainGUI + 2
        VersionBadge.Parent = LeftPanel
        
        local BadgeCorner = Instance.new("UICorner")
        BadgeCorner.CornerRadius = UDim.new(0, 8)
        BadgeCorner.Parent = VersionBadge
        
        local badgeTextSize = GetResponsiveValue(14, 11, 12)
        local BadgeText = Instance.new("TextLabel")
        BadgeText.Text = "v8.0"
        BadgeText.Size = UDim2.new(1, 0, 1, 0)
        BadgeText.BackgroundTransparency = 1
        BadgeText.Font = Enum.Font.GothamBold
        BadgeText.TextColor3 = Color3.fromRGB(0, 0, 0)
        BadgeText.TextSize = badgeTextSize
        BadgeText.ZIndex = GUI.ZLayers.MainGUI + 3
        BadgeText.Parent = VersionBadge
        
        -- Pulse effect on badge
        GUI.AddTask(task.spawn(function()
            while VersionBadge and VersionBadge.Parent do
                Tween(VersionBadge, {BackgroundColor3 = GUI.Colors.PrimaryGlow}, 1.5, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut)
                task.wait(1.5)
                if not VersionBadge or not VersionBadge.Parent then break end
                Tween(VersionBadge, {BackgroundColor3 = GUI.Colors.Primary}, 1.5, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut)
                task.wait(1.5)
            end
        end))
    end
    
    -- ============================================
    -- RIGHT PANEL - NO IMAGE, JUST OPAQUE BACKGROUND + STATS
    -- ============================================
    
    local ContentPanel = Instance.new("Frame")
    ContentPanel.Name = "ContentPanel"
    ContentPanel.Size = UDim2.new(0, rightPanelWidth, 1, -controlBarHeight)
    ContentPanel.Position = UDim2.new(0, leftPanelWidth, 0, controlBarHeight)
    ContentPanel.BackgroundColor3 = GUI.Colors.Surface
    ContentPanel.BackgroundTransparency = 0.2
    ContentPanel.BorderSizePixel = 0
    ContentPanel.ClipsDescendants = true
    ContentPanel.ZIndex = GUI.ZLayers.MainGUI
    ContentPanel.Parent = GUI.MainFrame
    
    -- Header (Compact)
    local headerHeight = GetResponsiveValue(70, 58, 64)
    local Header = Instance.new("Frame")
    Header.Size = UDim2.new(1, 0, 0, headerHeight)
    Header.BackgroundTransparency = 1
    Header.ZIndex = GUI.ZLayers.MainGUI + 1
    Header.Parent = ContentPanel
    
    local headerTitleSize = GetResponsiveValue(20, 16, 18)
    local headerPadding = GetResponsiveValue(20, 14, 17)
    
    local HeaderTitle = Instance.new("TextLabel")
    HeaderTitle.Text = "CONTROL PANEL"
    HeaderTitle.Size = UDim2.new(1, -headerPadding * 2, 0, headerTitleSize + 10)
    HeaderTitle.Position = UDim2.new(0, headerPadding, 0, 14)
    HeaderTitle.BackgroundTransparency = 1
    HeaderTitle.Font = Enum.Font.GothamBold
    HeaderTitle.TextColor3 = GUI.Colors.Text
    HeaderTitle.TextSize = headerTitleSize
    HeaderTitle.TextXAlignment = Enum.TextXAlignment.Left
    HeaderTitle.ZIndex = GUI.ZLayers.MainGUI + 2
    HeaderTitle.Parent = Header
    
    local subtitleSize = GetResponsiveValue(10, 8, 9)
    local Subtitle = Instance.new("TextLabel")
    Subtitle.Text = "Total Lifetime Stats"
    Subtitle.Size = UDim2.new(1, -headerPadding * 2, 0, subtitleSize + 6)
    Subtitle.Position = UDim2.new(0, headerPadding, 0, headerTitleSize + 26)
    Subtitle.BackgroundTransparency = 1
    Subtitle.Font = Enum.Font.Gotham
    Subtitle.TextColor3 = GUI.Colors.Primary
    Subtitle.TextSize = subtitleSize
    Subtitle.TextXAlignment = Enum.TextXAlignment.Left
    Subtitle.ZIndex = GUI.ZLayers.MainGUI + 2
    Subtitle.Parent = Header
    
    -- Stats Container (Compact)
    local statsPadding = GetResponsiveValue(20, 14, 17)
    local statsTop = headerHeight + 6
    
    local StatsContainer = Instance.new("ScrollingFrame")
    StatsContainer.Position = UDim2.new(0, statsPadding, 0, statsTop)
    StatsContainer.Size = UDim2.new(1, -statsPadding * 2, 1, -statsTop - 10)
    StatsContainer.BackgroundTransparency = 1
    StatsContainer.BorderSizePixel = 0
    StatsContainer.ScrollBarThickness = 4
    StatsContainer.ScrollBarImageColor3 = GUI.Colors.Primary
    StatsContainer.CanvasSize = UDim2.new(0, 0, 0, 0)
    StatsContainer.AutomaticCanvasSize = Enum.AutomaticSize.Y
    StatsContainer.ZIndex = GUI.ZLayers.MainGUI + 1
    StatsContainer.Parent = ContentPanel
    
    local StatsLayout = Instance.new("UIListLayout")
    StatsLayout.SortOrder = Enum.SortOrder.LayoutOrder
    StatsLayout.Padding = UDim.new(0, GetResponsiveValue(10, 8, 9))
    StatsLayout.Parent = StatsContainer
    
    -- Create Stat Card Function (COMPACT)
    local function CreateStatCard(label, value, iconType, order)
        local cardHeight = GetResponsiveValue(68, 56, 62)
        
        local Card = Instance.new("Frame")
        Card.Size = UDim2.new(1, 0, 0, cardHeight)
        Card.BackgroundColor3 = GUI.Colors.SurfaceLight
        Card.BorderSizePixel = 0
        Card.LayoutOrder = order
        Card.ZIndex = GUI.ZLayers.MainGUI + 2
        Card.Parent = StatsContainer
        
        local CardCorner = Instance.new("UICorner")
        CardCorner.CornerRadius = UDim.new(0, GetResponsiveValue(12, 10, 11))
        CardCorner.Parent = Card
        
        local CardStroke = Instance.new("UIStroke")
        CardStroke.Color = GUI.Colors.Border
        CardStroke.Thickness = 1
        CardStroke.Transparency = 0.6
        CardStroke.Parent = Card
        
        -- Icon Container (Compact)
        local iconContainerSize = GetResponsiveValue(48, 42, 45)
        local iconContainerX = GetResponsiveValue(14, 11, 12)
        
        local IconContainer = Instance.new("Frame")
        IconContainer.Size = UDim2.new(0, iconContainerSize, 0, iconContainerSize)
        IconContainer.Position = UDim2.new(0, iconContainerX, 0.5, -iconContainerSize/2)
        IconContainer.BackgroundColor3 = GUI.Colors.Surface
        IconContainer.BorderSizePixel = 0
        IconContainer.ZIndex = GUI.ZLayers.MainGUI + 3
        IconContainer.Parent = Card
        
        local IconCorner = Instance.new("UICorner")
        IconCorner.CornerRadius = UDim.new(0, GetResponsiveValue(12, 10, 11))
        IconCorner.Parent = IconContainer
        
        local IconStroke = Instance.new("UIStroke")
        IconStroke.Color = GUI.Colors.Primary
        IconStroke.Thickness = 1.5
        IconStroke.Transparency = 0.5
        IconStroke.Parent = IconContainer
        
        -- Icon
        local iconSize = GetResponsiveValue(26, 22, 24)
        local Icon = Icons.Create(IconContainer, iconType, iconSize, GUI.Colors.Primary)
        Icon.Position = UDim2.new(0.5, -iconSize/2, 0.5, -iconSize/2)
        Icon.ZIndex = GUI.ZLayers.MainGUI + 4
        
        -- Text
        local labelX = iconContainerX + iconContainerSize + GetResponsiveValue(12, 10, 11)
        local labelSize = GetResponsiveValue(10, 8, 9)
        
        local Label = Instance.new("TextLabel")
        Label.Text = label
        Label.Size = UDim2.new(1, -labelX - 8, 0, labelSize + 8)
        Label.Position = UDim2.new(0, labelX, 0, cardHeight * 0.22)
        Label.BackgroundTransparency = 1
        Label.Font = Enum.Font.GothamMedium
        Label.TextSize = labelSize
        Label.TextColor3 = GUI.Colors.TextMuted
        Label.TextXAlignment = Enum.TextXAlignment.Left
        Label.ZIndex = GUI.ZLayers.MainGUI + 3
        Label.Parent = Card
        
        local valueSize = GetResponsiveValue(22, 16, 19)
        
        local Value = Instance.new("TextLabel")
        Value.Text = value
        Value.Size = UDim2.new(1, -labelX - 8, 0, valueSize + 6)
        Value.Position = UDim2.new(0, labelX, 0, cardHeight * 0.56)
        Value.BackgroundTransparency = 1
        Value.Font = Enum.Font.GothamBold
        Value.TextSize = valueSize
        Value.TextColor3 = GUI.Colors.Text
        Value.TextXAlignment = Enum.TextXAlignment.Left
        Value.TextTruncate = Enum.TextTruncate.AtEnd
        Value.ZIndex = GUI.ZLayers.MainGUI + 3
        Value.Parent = Card
        
        -- Hover effects
        local hoverConnection = Card.MouseEnter:Connect(function()
            Tween(CardStroke, {Transparency = 0.2, Color = GUI.Colors.Primary}, 0.2)
            Tween(IconStroke, {Transparency = 0.1}, 0.2)
            Tween(Card, {BackgroundColor3 = GUI.Colors.Surface}, 0.2)
        end)
        GUI.AddConnection(hoverConnection)
        
        local leaveConnection = Card.MouseLeave:Connect(function()
            Tween(CardStroke, {Transparency = 0.6, Color = GUI.Colors.Border}, 0.2)
            Tween(IconStroke, {Transparency = 0.5}, 0.2)
            Tween(Card, {BackgroundColor3 = GUI.Colors.SurfaceLight}, 0.2)
        end)
        GUI.AddConnection(leaveConnection)
        
        task.wait(order * 0.03)
        
        return Value
    end
    
    -- Load persistent data
    local stats = PersistentStorage:GetStats()
    
    -- Create stat cards - SHOWING TOTAL STATS
    GUIVars.TargetValue = CreateStatCard("TARGET", "Searching...", "target", 1)
    GUIVars.StateValue = CreateStatCard("STATUS", "Initializing", "status", 2)
    GUIVars.BountyValue = CreateStatCard("TOTAL BOUNTY", "+" .. tostring(stats.total_bounty), "bounty", 3)
    GUIVars.TimeValue = CreateStatCard("TOTAL TIME", "0:00", "time", 4)
    
    getgenv().GUIVars = GUIVars
    
    -- Dragging functionality
    local dragging, dragInput, dragStart, startPos
    
    local dragBeganConnection = ControlsBar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or
           input.UserInputType == Enum.UserInputType.Touch then
            if GUI.IsMinimized then return end
            
            dragging = true
            dragStart = input.Position
            startPos = GUI.MainFrame.Position
            
            local endConnection
            endConnection = input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                    if endConnection then
                        endConnection:Disconnect()
                    end
                end
            end)
        end
    end)
    GUI.AddConnection(dragBeganConnection)
    
    local dragChangedConnection = ControlsBar.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or
           input.UserInputType == Enum.UserInputType.Touch then
            dragInput = input
        end
    end)
    GUI.AddConnection(dragChangedConnection)
    
    local inputChangedConnection = UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging and GUI.MainFrame and GUI.MainFrame.Parent then
            local delta = input.Position - dragStart
            GUI.MainFrame.Position = UDim2.new(
                startPos.X.Scale,
                startPos.X.Offset + delta.X,
                startPos.Y.Scale,
                startPos.Y.Offset + delta.Y
            )
        end
    end)
    GUI.AddConnection(inputChangedConnection)
    
    -- Entrance animation
    Tween(GUI.MainFrame, {Size = UDim2.new(0, mainWidth, 0, mainHeight)}, 0.8, Enum.EasingStyle.Back, Enum.EasingDirection.Out)
    
    -- Initialize assets
    task.spawn(function()
        GUI.InitAssets()
    end)
    
    -- Logger
    local Logger = {}
    
    function Logger:Log(m)
        if GUIVars.StateValue and GUIVars.StateValue.Parent then
            GUIVars.StateValue.Text = tostring(m)
        end
    end
    
    function Logger:Info(m) self:Log(m) end
    function Logger:Success(m) self:Log(m) end
    function Logger:Warning(m) self:Log(m) end
    function Logger:Error(m) self:Log(m) end
    
    function Logger:Target(m)
        if GUIVars.TargetValue and GUIVars.TargetValue.Parent then
            GUIVars.TargetValue.Text = tostring(m)
        end
    end
    
    return Logger
end

-- ============================================
-- SERVER CHANGE SCREEN (USING CHANGE.WEBM)
-- ============================================

function GUI.ShowServerChangeScreen()
    if not GUI.SkibidiGui then return end
    
    local Screen = Instance.new("Frame")
    Screen.Name = "ServerHopScreen"
    Screen.Size = UDim2.new(1, 0, 1, 0)
    Screen.BackgroundColor3 = GUI.Colors.Background
    Screen.BackgroundTransparency = 0
    Screen.ZIndex = GUI.ZLayers.ServerChange
    Screen.Parent = GUI.SkibidiGui
    
    -- Load CHANGE.WEBM video background
    if GUI.Config.VideoBackgrounds then
        local VideoBg = Instance.new("VideoFrame")
        VideoBg.Size = UDim2.new(1, 0, 1, 0)
        VideoBg.BackgroundTransparency = 1
        VideoBg.Looped = true
        VideoBg.Volume = 0
        VideoBg.ZIndex = GUI.ZLayers.ServerChange + 1
        VideoBg.Parent = Screen
        
        local videoPath = ASSETS_FOLDER .. "/change.webm"
        if isfile and isfile(videoPath) then
            AssetDownloader:LoadAsset(videoPath, VideoBg)
            VideoBg:Play()
        end
    end
    
    local Overlay = Instance.new("Frame")
    Overlay.Size = UDim2.new(1, 0, 1, 0)
    Overlay.BackgroundColor3 = GUI.Colors.Overlay
    Overlay.BackgroundTransparency = 0.3
    Overlay.BorderSizePixel = 0
    Overlay.ZIndex = GUI.ZLayers.ServerChange + 2
    Overlay.Parent = Screen
    
    -- Content
    local containerWidth = GetResponsiveValue(500, 300, 400)
    local containerHeight = GetResponsiveValue(180, 140, 160)
    
    local Container = Instance.new("Frame")
    Container.Size = UDim2.new(0, containerWidth, 0, containerHeight)
    Container.Position = UDim2.new(0.5, -containerWidth/2, 0.5, -containerHeight/2)
    Container.BackgroundTransparency = 1
    Container.ZIndex = GUI.ZLayers.ServerChange + 3
    Container.Parent = Screen
    
    local titleSize = GetResponsiveValue(46, 30, 38)
    local Title = Instance.new("TextLabel")
    Title.Text = "CHANGING SERVER"
    Title.Size = UDim2.new(1, 0, 0, titleSize + 20)
    Title.BackgroundTransparency = 1
    Title.Font = Enum.Font.GothamBold
    Title.TextSize = titleSize
    Title.TextColor3 = GUI.Colors.Text
    Title.TextTransparency = 1
    Title.ZIndex = GUI.ZLayers.ServerChange + 4
    Title.Parent = Container
    
    local subtitleSize = GetResponsiveValue(18, 12, 15)
    local Subtitle = Instance.new("TextLabel")
    Subtitle.Text = "Finding optimal server..."
    Subtitle.Size = UDim2.new(1, 0, 0, subtitleSize + 12)
    Subtitle.Position = UDim2.new(0, 0, 0, titleSize + 28)
    Subtitle.BackgroundTransparency = 1
    Subtitle.Font = Enum.Font.Gotham
    Subtitle.TextSize = subtitleSize
    Subtitle.TextColor3 = GUI.Colors.Primary
    Subtitle.TextTransparency = 1
    Subtitle.ZIndex = GUI.ZLayers.ServerChange + 4
    Subtitle.Parent = Container
    
    -- Progress bar
    local progressY = titleSize + 70
    local ProgressBg = Instance.new("Frame")
    ProgressBg.Size = UDim2.new(1, 0, 0, 5)
    ProgressBg.Position = UDim2.new(0, 0, 0, progressY)
    ProgressBg.BackgroundColor3 = GUI.Colors.Surface
    ProgressBg.BorderSizePixel = 0
    ProgressBg.BackgroundTransparency = 1
    ProgressBg.ZIndex = GUI.ZLayers.ServerChange + 4
    ProgressBg.Parent = Container
    
    local ProgressCorner = Instance.new("UICorner")
    ProgressCorner.CornerRadius = UDim.new(1, 0)
    ProgressCorner.Parent = ProgressBg
    
    local Progress = Instance.new("Frame")
    Progress.Size = UDim2.new(0, 0, 1, 0)
    Progress.BackgroundColor3 = GUI.Colors.Primary
    Progress.BorderSizePixel = 0
    Progress.ZIndex = GUI.ZLayers.ServerChange + 5
    Progress.Parent = ProgressBg
    
    local ProgressCorner2 = Instance.new("UICorner")
    ProgressCorner2.CornerRadius = UDim.new(1, 0)
    ProgressCorner2.Parent = Progress
    
    -- Animations
    Tween(Title, {TextTransparency = 0}, 0.7)
    task.wait(0.1)
    Tween(Subtitle, {TextTransparency = 0}, 0.7)
    task.wait(0.1)
    Tween(ProgressBg, {BackgroundTransparency = 0.4}, 0.7)
    
    Tween(Progress, {Size = UDim2.new(1, 0, 1, 0)}, 3.5, Enum.EasingStyle.Linear)
end

-- ============================================
-- BOOST SCREEN (USING BOOST.WEBM)
-- ============================================

function GUI.ShowBoostScreen()
    if GUI._BoostScreen then
        pcall(function() GUI._BoostScreen:Destroy() end)
    end
    
    local Screen = Instance.new("Frame")
    Screen.Name = "BoostScreen"
    Screen.Size = UDim2.new(1, 0, 1, 0)
    Screen.BackgroundTransparency = 1
    Screen.ZIndex = GUI.ZLayers.ServerChange
    Screen.Parent = GUI.SkibidiGui
    
    GUI._BoostScreen = Screen
    
    -- Load BOOST.WEBM
    local BoostVideo = Instance.new("VideoFrame")
    BoostVideo.Size = UDim2.new(1, 0, 1, 0)
    BoostVideo.BackgroundTransparency = 1
    BoostVideo.Looped = false
    BoostVideo.Volume = 0.3
    BoostVideo.ZIndex = GUI.ZLayers.ServerChange + 1
    BoostVideo.Parent = Screen
    
    local videoPath = ASSETS_FOLDER .. "/boost.webm"
    if isfile and isfile(videoPath) then
        AssetDownloader:LoadAsset(videoPath, BoostVideo)
        BoostVideo:Play()
        
        -- Auto-remove after video ends
        task.spawn(function()
            task.wait(5) -- Estimate video length
            if Screen and Screen.Parent then
                Tween(Screen, {BackgroundTransparency = 1}, 0.5)
                task.wait(0.6)
                Screen:Destroy()
            end
            GUI._BoostScreen = nil
        end)
    end
end

-- ============================================
-- CLEANUP
-- ============================================

function GUI.Cleanup()
    GUI.SaveMusicState()
    
    -- Save session data before cleanup
    if getgenv().GetCurrentBounty then
        local currentBounty = getgenv().GetCurrentBounty()
        local initialBounty = getgenv().InitialBounty or 0
        local sessionGain = currentBounty - initialBounty
        local totalKills = getgenv().TotalKills or 0
        local sessionTime = math.floor(tick() - (getgenv().SessionStartTime or tick()))
        
        PersistentStorage:UpdateSession(sessionGain, totalKills, sessionTime)
    end
    
    for _, tween in ipairs(GUI.RunningTweens) do
        pcall(function() if tween then tween:Cancel() end end)
    end
    GUI.RunningTweens = {}
    
    for _, taskThread in ipairs(GUI.Tasks) do
        pcall(function() if taskThread then task.cancel(taskThread) end end)
    end
    GUI.Tasks = {}
    
    for _, connection in ipairs(GUI.Connections) do
        pcall(function()
            if connection and connection.Connected then
                connection:Disconnect()
            end
        end)
    end
    GUI.Connections = {}
    
    if GUI.MusicSound then
        pcall(function()
            GUI.MusicSound:Stop()
            GUI.MusicSound:Destroy()
        end)
        GUI.MusicSound = nil
    end
    
    if GUI._BoostScreen then
        pcall(function() GUI._BoostScreen:Destroy() end)
        GUI._BoostScreen = nil
    end
    
    if GUI.VideoBackground then
        pcall(function() GUI.VideoBackground:Destroy() end)
        GUI.VideoBackground = nil
    end
    
    if GUI.SkibidiGui then
        pcall(function() GUI.SkibidiGui:Destroy() end)
        GUI.SkibidiGui = nil
    end
    
    GUI.MainFrame = nil
end

getgenv().SkibidiGUI_v8_Fixed = GUI

return GUI
