-- ============================================
-- ULTIMATE SKIBIDI GUI v8.0 - REVOLUTIONARY
-- Video backgrounds | Live asset downloading with progress
-- Persistent storage across sessions | Premium icons
-- Enhanced visual effects | Professional UI/UX
-- ============================================

local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local CoreGui = game:GetService("CoreGui")
local SoundService = game:GetService("SoundService")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local HttpService = game:GetService("HttpService")

local GUI = {}
GUI.Config = {}
GUI.SkibidiGui = nil
GUI.MainFrame = nil
GUI.VideoBackground = nil
GUI.MusicSound = nil
GUI.Connections = {}
GUI.Tasks = {}
GUI.RunningTweens = {}
GUI.SessionStartTime = tick()
GUI._BoostScreen = nil
GUI.IsMinimized = false
GUI.IsPaused = false
GUI.IsMobile = false
GUI.IsTablet = false
GUI.ScreenSize = Vector2.new(0, 0)
GUI.PersistentData = nil
GUI.DownloadQueue = {}
GUI.DownloadProgress = {}

-- Enhanced color palette
GUI.Colors = {
    Background = Color3.fromRGB(6, 8, 15),
    Surface = Color3.fromRGB(12, 15, 25),
    SurfaceLight = Color3.fromRGB(20, 24, 38),
    Primary = Color3.fromRGB(88, 166, 255),
    PrimaryGlow = Color3.fromRGB(120, 190, 255),
    Success = Color3.fromRGB(52, 211, 153),
    Warning = Color3.fromRGB(251, 191, 36),
    Error = Color3.fromRGB(239, 68, 68),
    Text = Color3.fromRGB(255, 255, 255),
    TextMuted = Color3.fromRGB(156, 163, 175),
    Border = Color3.fromRGB(40, 48, 70),
    Overlay = Color3.fromRGB(0, 0, 0),
    Accent1 = Color3.fromRGB(168, 85, 247),
    Accent2 = Color3.fromRGB(236, 72, 153),
    Accent3 = Color3.fromRGB(34, 211, 238),
}

-- Z-INDEX LAYERS
GUI.ZLayers = {
    VideoBackground = 1000,
    MainGUI = 10000,
    Controls = 10100,
    LoadingScreen = 20000,
    ServerChange = 25000
}

-- Configuration
local WORKSPACE_FOLDER = "cuackerdoing"
local ASSETS_FOLDER = WORKSPACE_FOLDER .. "/assets"
local DATA_FILE = WORKSPACE_FOLDER .. "/persistent_data.json"
local MUSIC_TIME_FILE = WORKSPACE_FOLDER .. "/musictime.txt"
local ASSETS_REPO = "https://raw.githubusercontent.com/Ryu-Dev-here/assetsfora/main/"

-- Asset definitions - supports video (webm/mp4), images, audio
local ASSETS = {
    {name = "background.webm", type = "video", size = 2800000, priority = 1},
    {name = "boost.webm", type = "video", size = 1900000, priority = 2},
    {name = "change.webm", type = "video", size = 1600000, priority = 3},
    {name = "sound.mp3", type = "audio", size = 3800000, priority = 1},
    {name = "backlua.png", type = "image", size = 850000, priority = 4}, -- Fallback
}

GUI.Config = {
    AutoFarmEnabled = true,
    MusicEnabled = true,
    MusicVolume = 0.5,
    FastMode = false,
    VideoBackgrounds = true
}

-- ============================================
-- PERSISTENT STORAGE SYSTEM (IMPROVED)
-- ============================================

local PersistentStorage = {}

function PersistentStorage:Init()
    pcall(function()
        if makefolder and not isfolder(WORKSPACE_FOLDER) then
            makefolder(WORKSPACE_FOLDER)
        end
        if makefolder and not isfolder(ASSETS_FOLDER) then
            makefolder(ASSETS_FOLDER)
        end
    end)
end

function PersistentStorage:Load()
    local success, data = pcall(function()
        if not isfile or not readfile then return nil end
        if not isfile(DATA_FILE) then return nil end
        
        local content = readfile(DATA_FILE)
        return HttpService:JSONDecode(content)
    end)
    
    if success and data and type(data) == "table" then
        return data
    end
    
    return {
        -- Session stats
        sessionStartTime = os.time(),
        totalBountyGained = 0,
        totalKills = 0,
        totalTimeSeconds = 0,
        
        -- Current session
        currentSessionBounty = 0,
        currentSessionKills = 0,
        currentSessionTime = 0,
        
        -- Historical data
        sessions = {},
        lifetimeStats = {
            totalSessions = 0,
            averageBountyPerSession = 0,
            averageKillsPerSession = 0,
            bestSession = {bounty = 0, kills = 0, time = 0}
        }
    }
end

function PersistentStorage:Save(data)
    pcall(function()
        if not writefile then return end
        
        local content = HttpService:JSONEncode(data)
        writefile(DATA_FILE, content)
    end)
end

function PersistentStorage:UpdateSession(bountyGain, kills, timeElapsed)
    local data = self:Load()
    
    -- Update totals
    data.totalBountyGained = (data.totalBountyGained or 0) + bountyGain
    data.totalKills = (data.totalKills or 0) + kills
    data.totalTimeSeconds = (data.totalTimeSeconds or 0) + timeElapsed
    
    -- Update current session
    data.currentSessionBounty = bountyGain
    data.currentSessionKills = kills
    data.currentSessionTime = timeElapsed
    
    -- Add to session history
    table.insert(data.sessions, {
        timestamp = os.time(),
        bounty = bountyGain,
        kills = kills,
        time = timeElapsed
    })
    
    -- Keep only last 100 sessions
    if #data.sessions > 100 then
        table.remove(data.sessions, 1)
    end
    
    -- Update lifetime stats
    data.lifetimeStats.totalSessions = #data.sessions
    if #data.sessions > 0 then
        local totalB, totalK = 0, 0
        for _, session in ipairs(data.sessions) do
            totalB = totalB + (session.bounty or 0)
            totalK = totalK + (session.kills or 0)
        end
        data.lifetimeStats.averageBountyPerSession = math.floor(totalB / #data.sessions)
        data.lifetimeStats.averageKillsPerSession = math.floor(totalK / #data.sessions)
    end
    
    -- Track best session
    if bountyGain > (data.lifetimeStats.bestSession.bounty or 0) then
        data.lifetimeStats.bestSession = {
            bounty = bountyGain,
            kills = kills,
            time = timeElapsed,
            timestamp = os.time()
        }
    end
    
    self:Save(data)
    return data
end

function PersistentStorage:GetStats()
    local data = self:Load()
    return {
        total_bounty = data.totalBountyGained or 0,
        total_kills = data.totalKills or 0,
        total_time = data.totalTimeSeconds or 0,
        session_bounty = data.currentSessionBounty or 0,
        session_kills = data.currentSessionKills or 0,
        session_time = data.currentSessionTime or 0,
        lifetime = data.lifetimeStats or {}
    }
end

PersistentStorage:Init()
GUI.PersistentData = PersistentStorage:Load()

-- ============================================
-- DEVICE DETECTION
-- ============================================

local function DetectDevice()
    local viewportSize = workspace.CurrentCamera.ViewportSize
    GUI.ScreenSize = viewportSize
    
    if viewportSize.X < 600 or (UserInputService.TouchEnabled and not UserInputService.KeyboardEnabled and not UserInputService.GamepadEnabled) then
        GUI.IsMobile = true
        GUI.IsTablet = false
    elseif viewportSize.X >= 600 and viewportSize.X < 1024 and UserInputService.TouchEnabled then
        GUI.IsMobile = false
        GUI.IsTablet = true
    else
        GUI.IsMobile = false
        GUI.IsTablet = false
    end
end

local function GetResponsiveValue(desktopValue, mobileValue, tabletValue)
    if GUI.IsMobile then
        return mobileValue or (desktopValue * 0.6)
    elseif GUI.IsTablet then
        return tabletValue or (desktopValue * 0.8)
    else
        return desktopValue
    end
end

-- ============================================
-- HELPER FUNCTIONS
-- ============================================

function GUI.AddConnection(connection)
    if connection then
        table.insert(GUI.Connections, connection)
    end
    return connection
end

function GUI.AddTask(taskThread)
    if taskThread then
        table.insert(GUI.Tasks, taskThread)
    end
    return taskThread
end

local function Tween(object, properties, duration, style, direction, callback)
    if not object or not object.Parent then return nil end
    
    local success, tween = pcall(function()
        return TweenService:Create(
            object,
            TweenInfo.new(
                duration or 0.4,
                style or Enum.EasingStyle.Quart,
                direction or Enum.EasingDirection.Out
            ),
            properties
        )
    end)
    
    if not success or not tween then return nil end
    
    table.insert(GUI.RunningTweens, tween)
    
    tween.Completed:Connect(function()
        local index = table.find(GUI.RunningTweens, tween)
        if index then
            table.remove(GUI.RunningTweens, index)
        end
        if callback then callback() end
    end)
    
    pcall(function() tween:Play() end)
    return tween
end

-- ============================================
-- PREMIUM ICON SYSTEM
-- ============================================

local Icons = {}

function Icons.Create(parent, iconType, size, color)
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(0, size, 0, size)
    frame.BackgroundTransparency = 1
    frame.Parent = parent
    
    local canvas = Instance.new("Frame")
    canvas.Size = UDim2.new(1, 0, 1, 0)
    canvas.BackgroundTransparency = 1
    canvas.Parent = frame
    
    color = color or GUI.Colors.Primary
    
    if iconType == "target" then
        -- Premium crosshair with pulse effect
        local outerCircle = Instance.new("Frame")
        outerCircle.Size = UDim2.new(0.8, 0, 0.8, 0)
        outerCircle.Position = UDim2.new(0.1, 0, 0.1, 0)
        outerCircle.BackgroundTransparency = 1
        outerCircle.Parent = canvas
        
        local outerStroke = Instance.new("UIStroke")
        outerStroke.Color = color
        outerStroke.Thickness = 3
        outerStroke.Parent = outerCircle
        
        local outerCorner = Instance.new("UICorner")
        outerCorner.CornerRadius = UDim.new(1, 0)
        outerCorner.Parent = outerCircle
        
        -- Inner ring
        local innerCircle = Instance.new("Frame")
        innerCircle.Size = UDim2.new(0.5, 0, 0.5, 0)
        innerCircle.Position = UDim2.new(0.25, 0, 0.25, 0)
        innerCircle.BackgroundTransparency = 1
        innerCircle.Parent = canvas
        
        local innerStroke = Instance.new("UIStroke")
        innerStroke.Color = color
        innerStroke.Thickness = 2
        innerStroke.Transparency = 0.5
        innerStroke.Parent = innerCircle
        
        local innerCorner = Instance.new("UICorner")
        innerCorner.CornerRadius = UDim.new(1, 0)
        innerCorner.Parent = innerCircle
        
        -- Center dot with glow
        local centerDot = Instance.new("Frame")
        centerDot.Size = UDim2.new(0.2, 0, 0.2, 0)
        centerDot.Position = UDim2.new(0.4, 0, 0.4, 0)
        centerDot.BackgroundColor3 = color
        centerDot.Parent = canvas
        
        local dotCorner = Instance.new("UICorner")
        dotCorner.CornerRadius = UDim.new(1, 0)
        dotCorner.Parent = centerDot
        
        local dotGlow = Instance.new("UIStroke")
        dotGlow.Color = color
        dotGlow.Thickness = 2
        dotGlow.Transparency = 0.6
        dotGlow.Parent = centerDot
        
        -- Crosshair lines
        for i = 0, 3 do
            local line = Instance.new("Frame")
            line.Size = UDim2.new(0, 3, 0.15, 0)
            line.Position = UDim2.new(0.5, -1.5, 0.5, 0)
            line.AnchorPoint = Vector2.new(0.5, 0.5)
            line.BackgroundColor3 = color
            line.Rotation = i * 90
            line.Parent = canvas
            
            local lineCorner = Instance.new("UICorner")
            lineCorner.CornerRadius = UDim.new(1, 0)
            lineCorner.Parent = line
            
            -- Position outside circles
            if i == 0 then line.Position = UDim2.new(0.5, -1.5, 0.08, 0)
            elseif i == 1 then line.Position = UDim2.new(0.92, -1.5, 0.5, 0)
            elseif i == 2 then line.Position = UDim2.new(0.5, -1.5, 0.92, 0)
            else line.Position = UDim2.new(0.08, -1.5, 0.5, 0) end
        end
        
    elseif iconType == "status" then
        -- Modern activity indicator with waves
        local waves = {
            {size = 0.35, alpha = 1},
            {size = 0.55, alpha = 0.6},
            {size = 0.75, alpha = 0.3}
        }
        
        for _, wave in ipairs(waves) do
            local ring = Instance.new("Frame")
            ring.Size = UDim2.new(wave.size, 0, wave.size, 0)
            ring.Position = UDim2.new((1 - wave.size) / 2, 0, (1 - wave.size) / 2, 0)
            ring.BackgroundTransparency = 1
            ring.Parent = canvas
            
            local stroke = Instance.new("UIStroke")
            stroke.Color = color
            stroke.Thickness = 2.5
            stroke.Transparency = 1 - wave.alpha
            stroke.Parent = ring
            
            local corner = Instance.new("UICorner")
            corner.CornerRadius = UDim.new(1, 0)
            corner.Parent = ring
        end
        
        -- Center pulse
        local center = Instance.new("Frame")
        center.Size = UDim2.new(0.25, 0, 0.25, 0)
        center.Position = UDim2.new(0.375, 0, 0.375, 0)
        center.BackgroundColor3 = color
        center.Parent = canvas
        
        local centerCorner = Instance.new("UICorner")
        centerCorner.CornerRadius = UDim.new(1, 0)
        centerCorner.Parent = center
        
    elseif iconType == "bounty" then
        -- Premium diamond/gem with sparkle
        local diamond = Instance.new("Frame")
        diamond.Size = UDim2.new(0.6, 0, 0.6, 0)
        diamond.Position = UDim2.new(0.2, 0, 0.2, 0)
        diamond.BackgroundColor3 = color
        diamond.Rotation = 45
        diamond.Parent = canvas
        
        local diamondCorner = Instance.new("UICorner")
        diamondCorner.CornerRadius = UDim.new(0.15, 0)
        diamondCorner.Parent = diamond
        
        local diamondGlow = Instance.new("UIStroke")
        diamondGlow.Color = color
        diamondGlow.Thickness = 2
        diamondGlow.Transparency = 0.5
        diamondGlow.Parent = diamond
        
        -- Sparkle effects
        for i = 1, 4 do
            local sparkle = Instance.new("Frame")
            sparkle.Size = UDim2.new(0.15, 0, 0.03, 0)
            sparkle.Position = UDim2.new(0.5, 0, 0.5, 0)
            sparkle.AnchorPoint = Vector2.new(0.5, 0.5)
            sparkle.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
            sparkle.BackgroundTransparency = 0.3
            sparkle.Rotation = (i - 1) * 45
            sparkle.Parent = canvas
            
            local sparkleCorner = Instance.new("UICorner")
            sparkleCorner.CornerRadius = UDim.new(1, 0)
            sparkleCorner.Parent = sparkle
        end
        
    elseif iconType == "time" then
        -- Modern clock with smooth design
        local clockFace = Instance.new("Frame")
        clockFace.Size = UDim2.new(0.9, 0, 0.9, 0)
        clockFace.Position = UDim2.new(0.05, 0, 0.05, 0)
        clockFace.BackgroundTransparency = 1
        clockFace.Parent = canvas
        
        local clockStroke = Instance.new("UIStroke")
        clockStroke.Color = color
        clockStroke.Thickness = 3
        clockStroke.Parent = clockFace
        
        local clockCorner = Instance.new("UICorner")
        clockCorner.CornerRadius = UDim.new(1, 0)
        clockCorner.Parent = clockFace
        
        -- Hour markers
        for i = 0, 11 do
            local marker = Instance.new("Frame")
            marker.Size = UDim2.new(0, i % 3 == 0 and 3 or 2, 0.1, 0)
            marker.Position = UDim2.new(0.5, i % 3 == 0 and -1.5 or -1, 0.08, 0)
            marker.AnchorPoint = Vector2.new(0.5, 0)
            marker.BackgroundColor3 = color
            marker.BackgroundTransparency = i % 3 == 0 and 0 or 0.4
            marker.Rotation = i * 30
            marker.Parent = clockFace
            
            local markerCorner = Instance.new("UICorner")
            markerCorner.CornerRadius = UDim.new(1, 0)
            markerCorner.Parent = marker
        end
        
        -- Hour hand
        local hourHand = Instance.new("Frame")
        hourHand.Size = UDim2.new(0, 3.5, 0.3, 0)
        hourHand.Position = UDim2.new(0.5, -1.75, 0.5, 0)
        hourHand.AnchorPoint = Vector2.new(0.5, 1)
        hourHand.BackgroundColor3 = color
        hourHand.Rotation = 45
        hourHand.Parent = canvas
        
        local hourCorner = Instance.new("UICorner")
        hourCorner.CornerRadius = UDim.new(1, 0)
        hourCorner.Parent = hourHand
        
        -- Minute hand
        local minuteHand = Instance.new("Frame")
        minuteHand.Size = UDim2.new(0, 2.5, 0.42, 0)
        minuteHand.Position = UDim2.new(0.5, -1.25, 0.5, 0)
        minuteHand.AnchorPoint = Vector2.new(0.5, 1)
        minuteHand.BackgroundColor3 = color
        minuteHand.Rotation = 135
        minuteHand.Parent = canvas
        
        local minuteCorner = Instance.new("UICorner")
        minuteCorner.CornerRadius = UDim.new(1, 0)
        minuteCorner.Parent = minuteHand
        
        -- Center hub
        local centerHub = Instance.new("Frame")
        centerHub.Size = UDim2.new(0.15, 0, 0.15, 0)
        centerHub.Position = UDim2.new(0.425, 0, 0.425, 0)
        centerHub.BackgroundColor3 = color
        centerHub.ZIndex = 10
        centerHub.Parent = canvas
        
        local hubCorner = Instance.new("UICorner")
        hubCorner.CornerRadius = UDim.new(1, 0)
        hubCorner.Parent = centerHub
        
    end
    
    return frame
end

-- ============================================
-- ASSET DOWNLOADING SYSTEM
-- ============================================

local AssetDownloader = {}

function AssetDownloader:DownloadAsset(asset, onProgress)
    return GUI.AddTask(task.spawn(function()
        pcall(function()
            if not game.HttpGet then return end
            if not writefile then return end
            
            local path = ASSETS_FOLDER .. "/" .. asset.name
            
            -- Check if already exists
            if isfile and isfile(path) then
                if onProgress then
                    onProgress(asset.name, 1, asset.size, "cached")
                end
                return path
            end
            
            -- Download with progress simulation
            local success, data = pcall(function()
                if onProgress then
                    onProgress(asset.name, 0.1, asset.size, "downloading")
                end
                
                local content = game:HttpGet(ASSETS_REPO .. asset.name, true)
                
                if onProgress then
                    onProgress(asset.name, 0.8, asset.size, "writing")
                end
                
                writefile(path, content)
                
                if onProgress then
                    onProgress(asset.name, 1, asset.size, "complete")
                end
                
                return path
            end)
            
            if success and data then
                return data
            else
                if onProgress then
                    onProgress(asset.name, 0, asset.size, "failed")
                end
            end
        end)
    end))
end

function AssetDownloader:LoadAsset(assetPath, targetObject)
    pcall(function()
        local asset = getcustomasset or getsynasset
        if not asset then return end
        if not isfile or not isfile(assetPath) then return end
        
        local assetUrl = asset(assetPath)
        
        if targetObject:IsA("ImageLabel") or targetObject:IsA("ImageButton") then
            targetObject.Image = assetUrl
        elseif targetObject:IsA("VideoFrame") then
            targetObject.Video = assetUrl
        elseif targetObject:IsA("Sound") then
            targetObject.SoundId = assetUrl
        end
    end)
end

-- ============================================
-- LOADING SCREEN WITH LIVE PROGRESS
-- ============================================

function GUI.CreateAdvancedLoader()
    local loaderWidth = GetResponsiveValue(600, 350, 480)
    local loaderHeight = GetResponsiveValue(400, 280, 340)
    
    local LoaderScreen = Instance.new("Frame")
    LoaderScreen.Name = "AdvancedLoader"
    LoaderScreen.Size = UDim2.new(1, 0, 1, 0)
    LoaderScreen.BackgroundColor3 = GUI.Colors.Background
    LoaderScreen.BackgroundTransparency = 0
    LoaderScreen.ZIndex = GUI.ZLayers.LoadingScreen
    LoaderScreen.Parent = GUI.SkibidiGui
    
    -- Animated gradient background
    local gradientBg = Instance.new("Frame")
    gradientBg.Size = UDim2.new(1, 0, 1, 0)
    gradientBg.BackgroundColor3 = GUI.Colors.Background
    gradientBg.ZIndex = GUI.ZLayers.LoadingScreen
    gradientBg.Parent = LoaderScreen
    
    local gradient = Instance.new("UIGradient")
    gradient.Color = ColorSequence.new{
        ColorSequenceKeypoint.new(0, GUI.Colors.Background),
        ColorSequenceKeypoint.new(0.5, GUI.Colors.Surface),
        ColorSequenceKeypoint.new(1, GUI.Colors.Background)
    }
    gradient.Rotation = 45
    gradient.Parent = gradientBg
    
    -- Animate gradient
    GUI.AddTask(task.spawn(function()
        while LoaderScreen and LoaderScreen.Parent do
            Tween(gradient, {Rotation = gradient.Rotation + 360}, 10, Enum.EasingStyle.Linear)
            task.wait(10)
        end
    end))
    
    -- Main container
    local Container = Instance.new("Frame")
    Container.Size = UDim2.new(0, loaderWidth, 0, loaderHeight)
    Container.Position = UDim2.new(0.5, -loaderWidth/2, 0.5, -loaderHeight/2)
    Container.BackgroundTransparency = 1
    Container.ZIndex = GUI.ZLayers.LoadingScreen + 1
    Container.Parent = LoaderScreen
    
    -- Logo
    local logoSize = GetResponsiveValue(72, 48, 60)
    local Logo = Instance.new("TextLabel")
    Logo.Text = "SKIBIDI"
    Logo.Size = UDim2.new(1, 0, 0, logoSize + 20)
    Logo.BackgroundTransparency = 1
    Logo.Font = Enum.Font.GothamBold
    Logo.TextColor3 = GUI.Colors.Text
    Logo.TextSize = logoSize
    Logo.TextTransparency = 1
    Logo.ZIndex = GUI.ZLayers.LoadingScreen + 2
    Logo.Parent = Container
    
    -- Version badge
    local badgeSize = GetResponsiveValue(15, 12, 13)
    local VersionBadge = Instance.new("TextLabel")
    VersionBadge.Text = "v8.0 ULTIMATE"
    VersionBadge.Size = UDim2.new(1, 0, 0, badgeSize + 16)
    VersionBadge.Position = UDim2.new(0, 0, 0, logoSize + 30)
    VersionBadge.BackgroundTransparency = 1
    VersionBadge.Font = Enum.Font.GothamMedium
    VersionBadge.TextColor3 = GUI.Colors.Primary
    VersionBadge.TextSize = badgeSize
    VersionBadge.TextTransparency = 1
    VersionBadge.ZIndex = GUI.ZLayers.LoadingScreen + 2
    VersionBadge.Parent = Container
    
    -- Overall progress
    local progressY = GetResponsiveValue(180, 140, 160)
    local ProgressBar = Instance.new("Frame")
    ProgressBar.Size = UDim2.new(1, -40, 0, 6)
    ProgressBar.Position = UDim2.new(0, 20, 0, progressY)
    ProgressBar.BackgroundColor3 = GUI.Colors.Surface
    ProgressBar.BorderSizePixel = 0
    ProgressBar.BackgroundTransparency = 1
    ProgressBar.ZIndex = GUI.ZLayers.LoadingScreen + 2
    ProgressBar.Parent = Container
    
    local ProgressCorner = Instance.new("UICorner")
    ProgressCorner.CornerRadius = UDim.new(1, 0)
    ProgressCorner.Parent = ProgressBar
    
    local Progress = Instance.new("Frame")
    Progress.Size = UDim2.new(0, 0, 1, 0)
    Progress.BackgroundColor3 = GUI.Colors.Primary
    Progress.BorderSizePixel = 0
    Progress.ZIndex = GUI.ZLayers.LoadingScreen + 3
    Progress.Parent = ProgressBar
    
    local ProgressCorner2 = Instance.new("UICorner")
    ProgressCorner2.CornerRadius = UDim.new(1, 0)
    ProgressCorner2.Parent = Progress
    
    -- Progress glow
    local Glow = Instance.new("Frame")
    Glow.Size = UDim2.new(1, 30, 1, 30)
    Glow.Position = UDim2.new(0, -15, 0, -15)
    Glow.BackgroundColor3 = GUI.Colors.Primary
    Glow.BackgroundTransparency = 0.5
    Glow.BorderSizePixel = 0
    Glow.ZIndex = GUI.ZLayers.LoadingScreen + 2
    Glow.Parent = Progress
    
    local GlowCorner = Instance.new("UICorner")
    GlowCorner.CornerRadius = UDim.new(1, 0)
    GlowCorner.Parent = Glow
    
    -- Status text
    local statusSize = GetResponsiveValue(16, 12, 14)
    local StatusText = Instance.new("TextLabel")
    StatusText.Text = "Initializing..."
    StatusText.Size = UDim2.new(1, -40, 0, statusSize + 10)
    StatusText.Position = UDim2.new(0, 20, 0, progressY + 30)
    StatusText.BackgroundTransparency = 1
    StatusText.Font = Enum.Font.GothamMedium
    StatusText.TextColor3 = GUI.Colors.TextMuted
    StatusText.TextSize = statusSize
    StatusText.TextTransparency = 1
    StatusText.TextXAlignment = Enum.TextXAlignment.Left
    StatusText.ZIndex = GUI.ZLayers.LoadingScreen + 2
    StatusText.Parent = Container
    
    -- Percentage
    local percentSize = GetResponsiveValue(48, 32, 40)
    local PercentText = Instance.new("TextLabel")
    PercentText.Text = "0%"
    PercentText.Size = UDim2.new(1, -40, 0, percentSize + 10)
    PercentText.Position = UDim2.new(0, 20, 0, progressY + 60)
    PercentText.BackgroundTransparency = 1
    PercentText.Font = Enum.Font.GothamBold
    PercentText.TextColor3 = GUI.Colors.Primary
    PercentText.TextSize = percentSize
    PercentText.TextTransparency = 1
    PercentText.TextXAlignment = Enum.TextXAlignment.Left
    PercentText.ZIndex = GUI.ZLayers.LoadingScreen + 2
    PercentText.Parent = Container
    
    -- Download details container
    local detailsY = progressY + 120
    local DetailsContainer = Instance.new("ScrollingFrame")
    DetailsContainer.Size = UDim2.new(1, -40, 0, 120)
    DetailsContainer.Position = UDim2.new(0, 20, 0, detailsY)
    DetailsContainer.BackgroundTransparency = 1
    DetailsContainer.ScrollBarThickness = 4
    DetailsContainer.ScrollBarImageColor3 = GUI.Colors.Primary
    DetailsContainer.CanvasSize = UDim2.new(0, 0, 0, 0)
    DetailsContainer.AutomaticCanvasSize = Enum.AutomaticSize.Y
    DetailsContainer.ZIndex = GUI.ZLayers.LoadingScreen + 2
    DetailsContainer.Parent = Container
    
    local DetailsLayout = Instance.new("UIListLayout")
    DetailsLayout.SortOrder = Enum.SortOrder.LayoutOrder
    DetailsLayout.Padding = UDim.new(0, 8)
    DetailsLayout.Parent = DetailsContainer
    
    -- Entrance animations
    Tween(Logo, {TextTransparency = 0}, 0.8)
    task.wait(0.2)
    Tween(VersionBadge, {TextTransparency = 0}, 0.8)
    task.wait(0.2)
    Tween(ProgressBar, {BackgroundTransparency = 0.5}, 0.8)
    Tween(StatusText, {TextTransparency = 0}, 0.8)
    Tween(PercentText, {TextTransparency = 0}, 0.8)
    
    local downloadItems = {}
    
    return {
        Screen = LoaderScreen,
        Progress = Progress,
        Status = StatusText,
        Percent = PercentText,
        Details = DetailsContainer,
        
        AddDownloadItem = function(assetName)
            local itemSize = GetResponsiveValue(13, 10, 11)
            local Item = Instance.new("Frame")
            Item.Size = UDim2.new(1, 0, 0, itemSize + 12)
            Item.BackgroundColor3 = GUI.Colors.SurfaceLight
            Item.BorderSizePixel = 0
            Item.ZIndex = GUI.ZLayers.LoadingScreen + 3
            Item.Parent = DetailsContainer
            
            local ItemCorner = Instance.new("UICorner")
            ItemCorner.CornerRadius = UDim.new(0, 6)
            ItemCorner.Parent = Item
            
            local NameLabel = Instance.new("TextLabel")
            NameLabel.Text = assetName
            NameLabel.Size = UDim2.new(0.6, -10, 1, 0)
            NameLabel.Position = UDim2.new(0, 10, 0, 0)
            NameLabel.BackgroundTransparency = 1
            NameLabel.Font = Enum.Font.GothamMedium
            NameLabel.TextColor3 = GUI.Colors.Text
            NameLabel.TextSize = itemSize
            NameLabel.TextXAlignment = Enum.TextXAlignment.Left
            NameLabel.TextTruncate = Enum.TextTruncate.AtEnd
            NameLabel.ZIndex = GUI.ZLayers.LoadingScreen + 4
            NameLabel.Parent = Item
            
            local StatusLabel = Instance.new("TextLabel")
            StatusLabel.Text = "Waiting..."
            StatusLabel.Size = UDim2.new(0.4, -10, 1, 0)
            StatusLabel.Position = UDim2.new(0.6, 0, 0, 0)
            StatusLabel.BackgroundTransparency = 1
            StatusLabel.Font = Enum.Font.Gotham
            StatusLabel.TextColor3 = GUI.Colors.TextMuted
            StatusLabel.TextSize = itemSize - 1
            StatusLabel.TextXAlignment = Enum.TextXAlignment.Right
            StatusLabel.ZIndex = GUI.ZLayers.LoadingScreen + 4
            StatusLabel.Parent = Item
            
            downloadItems[assetName] = {
                Frame = Item,
                Status = StatusLabel
            }
            
            return Item
        end,
        
        UpdateDownloadItem = function(assetName, progress, size, status)
            if downloadItems[assetName] then
                local statusText = ""
                local color = GUI.Colors.TextMuted
                
                if status == "downloading" then
                    statusText = string.format("%.0f%%", progress * 100)
                    color = GUI.Colors.Primary
                elseif status == "complete" then
                    statusText = "✓ Complete"
                    color = GUI.Colors.Success
                elseif status == "cached" then
                    statusText = "✓ Cached"
                    color = GUI.Colors.Success
                elseif status == "failed" then
                    statusText = "✗ Failed"
                    color = GUI.Colors.Error
                else
                    statusText = status
                end
                
                downloadItems[assetName].Status.Text = statusText
                downloadItems[assetName].Status.TextColor3 = color
            end
        end,
        
        Update = function(progress, statusText)
            if StatusText and StatusText.Parent then
                StatusText.Text = statusText or "Loading..."
            end
            if PercentText and PercentText.Parent then
                PercentText.Text = math.floor(progress * 100) .. "%"
            end
            if Progress and Progress.Parent then
                Tween(Progress, {Size = UDim2.new(progress, 0, 1, 0)}, 0.3)
            end
        end,
        
        Complete = function()
            if not LoaderScreen or not LoaderScreen.Parent then return end
            
            if StatusText then StatusText.Text = "Ready!" end
            if PercentText then PercentText.Text = "100%" end
            
            task.wait(0.6)
            
            Tween(LoaderScreen, {BackgroundTransparency = 1}, 0.8)
            
            for _, child in pairs(LoaderScreen:GetDescendants()) do
                if child:IsA("TextLabel") or child:IsA("Frame") then
                    pcall(function()
                        if child.TextTransparency then
                            Tween(child, {TextTransparency = 1, BackgroundTransparency = 1}, 0.8)
                        else
                            Tween(child, {BackgroundTransparency = 1}, 0.8)
                        end
                    end)
                end
            end
            
            task.wait(1)
            
            if LoaderScreen and LoaderScreen.Parent then
                LoaderScreen:Destroy()
            end
        end
    }
end

-- ============================================
-- ASSET INITIALIZATION WITH LIVE PROGRESS
-- ============================================

function GUI.InitAssets()
    local loader = GUI.CreateAdvancedLoader()
    if not loader then return end
    
    loader.Update(0.05, "Creating workspace...")
    
    PersistentStorage:Init()
    
    task.wait(0.3)
    loader.Update(0.1, "Preparing downloads...")
    
    -- Sort assets by priority
    table.sort(ASSETS, function(a, b)
        return (a.priority or 99) < (b.priority or 99)
    end)
    
    -- Add download items to UI
    for _, asset in ipairs(ASSETS) do
        loader.AddDownloadItem(asset.name)
    end
    
    task.wait(0.2)
    
    -- Download assets with progress
    local totalSize = 0
    local downloadedSize = 0
    
    for _, asset in ipairs(ASSETS) do
        totalSize = totalSize + asset.size
    end
    
    for i, asset in ipairs(ASSETS) do
        loader.Update(0.1 + (i - 1) * 0.7 / #ASSETS, "Downloading " .. asset.name .. "...")
        
        AssetDownloader:DownloadAsset(asset, function(name, progress, size, status)
            loader.UpdateDownloadItem(name, progress, size, status)
            
            if status == "complete" or status == "cached" then
                downloadedSize = downloadedSize + size
                local totalProgress = 0.1 + (downloadedSize / totalSize) * 0.7
                loader.Update(totalProgress, "Downloaded " .. name)
            end
        end)
        
        task.wait(0.1)
    end
    
    loader.Update(0.85, "Loading audio...")
    
    -- Initialize music
    pcall(function()
        GUI.MusicSound = Instance.new("Sound")
        GUI.MusicSound.Name = "SkibidiMusic"
        GUI.MusicSound.Looped = true
        GUI.MusicSound.Volume = GUI.Config.MusicVolume
        GUI.MusicSound.Parent = SoundService
        
        local musicPath = ASSETS_FOLDER .. "/sound.mp3"
        if isfile and isfile(musicPath) then
            AssetDownloader:LoadAsset(musicPath, GUI.MusicSound)
            
            -- Load saved position
            if isfile and isfile(MUSIC_TIME_FILE) and readfile then
                local savedTime = tonumber(readfile(MUSIC_TIME_FILE))
                if savedTime and savedTime > 0 then
                    GUI.MusicSound.TimePosition = savedTime
                end
            end
            
            GUI.MusicSound:Play()
        end
    end)
    
    task.wait(0.3)
    loader.Update(0.95, "Finalizing...")
    
    task.wait(0.3)
    loader.Update(1, "Complete!")
    task.wait(0.5)
    loader.Complete()
    
    -- Save music time on teleport
    local teleportConnection = Players.LocalPlayer.OnTeleport:Connect(function()
        GUI.SaveMusicState()
    end)
    GUI.AddConnection(teleportConnection)
end

-- ============================================
-- MUSIC STATE MANAGEMENT
-- ============================================

function GUI.SaveMusicState()
    if not GUI.MusicSound then return end
    
    pcall(function()
        if GUI.MusicSound.IsPlaying and writefile then
            local timePos = GUI.MusicSound.TimePosition
            if timePos and type(timePos) == "number" and timePos > 0 then
                writefile(MUSIC_TIME_FILE, tostring(timePos))
            end
        end
    end)
end

-- ============================================
-- MAIN GUI CREATION
-- ============================================

function GUI.CreateMainGUI()
    if GUI.SkibidiGui then
        GUI.Cleanup()
    end
    
    local lp = Players.LocalPlayer
    if not lp then return nil end
    
    DetectDevice()
    
    local GUIVars = {}
    
    -- Create ScreenGui
    GUI.SkibidiGui = Instance.new("ScreenGui")
    GUI.SkibidiGui.Name = "SkibidiGui"
    GUI.SkibidiGui.ResetOnSpawn = false
    GUI.SkibidiGui.IgnoreGuiInset = true
    GUI.SkibidiGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    
    local guiParented = pcall(function()
        GUI.SkibidiGui.Parent = CoreGui
    end)
    
    if not guiParented or not GUI.SkibidiGui.Parent then
        local playerGui = lp:WaitForChild("PlayerGui", 5)
        if playerGui then
            GUI.SkibidiGui.Parent = playerGui
        else
            return nil
        end
    end
    
    -- Responsive dimensions
    local panelWidth, panelHeight
    
    if GUI.IsMobile then
        panelWidth = math.min(GUI.ScreenSize.X * 0.9, 360)
        panelHeight = math.min(GUI.ScreenSize.Y * 0.8, 580)
    elseif GUI.IsTablet then
        panelWidth = 400
        panelHeight = 640
    else
        panelWidth = 440
        panelHeight = 700
    end
    
    local cornerRadius = GetResponsiveValue(20, 16, 18)
    local controlBarHeight = GetResponsiveValue(48, 40, 44)
    
    -- Video Background Layer
    if GUI.Config.VideoBackgrounds then
        GUI.VideoBackground = Instance.new("VideoFrame")
        GUI.VideoBackground.Size = UDim2.new(1, 0, 1, 0)
        GUI.VideoBackground.BackgroundTransparency = 1
        GUI.VideoBackground.Looped = true
        GUI.VideoBackground.Volume = 0
        GUI.VideoBackground.ZIndex = GUI.ZLayers.VideoBackground
        GUI.VideoBackground.Parent = GUI.SkibidiGui
        
        -- Load video
        local videoPath = ASSETS_FOLDER .. "/background.webm"
        if isfile and isfile(videoPath) then
            AssetDownloader:LoadAsset(videoPath, GUI.VideoBackground)
            GUI.VideoBackground:Play()
        end
        
        -- Overlay for readability
        local Overlay = Instance.new("Frame")
        Overlay.Size = UDim2.new(1, 0, 1, 0)
        Overlay.BackgroundColor3 = GUI.Colors.Overlay
        Overlay.BackgroundTransparency = 0.4
        Overlay.BorderSizePixel = 0
        Overlay.ZIndex = GUI.ZLayers.VideoBackground + 1
        Overlay.Parent = GUI.SkibidiGui
    end
    
    -- Main GUI Frame
    GUI.MainFrame = Instance.new("Frame")
    GUI.MainFrame.Name = "MainFrame"
    GUI.MainFrame.BackgroundColor3 = GUI.Colors.Background
    GUI.MainFrame.BackgroundTransparency = 0.1
    GUI.MainFrame.Position = UDim2.new(0, 20, 0.5, -panelHeight/2)
    GUI.MainFrame.Size = UDim2.new(0, 0, 0, panelHeight)
    GUI.MainFrame.BorderSizePixel = 0
    GUI.MainFrame.ClipsDescendants = true
    GUI.MainFrame.ZIndex = GUI.ZLayers.MainGUI
    GUI.MainFrame.Parent = GUI.SkibidiGui
    
    local MainCorner = Instance.new("UICorner")
    MainCorner.CornerRadius = UDim.new(0, cornerRadius)
    MainCorner.Parent = GUI.MainFrame
    
    local MainStroke = Instance.new("UIStroke")
    MainStroke.Color = GUI.Colors.Primary
    MainStroke.Thickness = 2
    MainStroke.Transparency = 0.3
    MainStroke.Parent = GUI.MainFrame
    
    -- Glow effect animation
    GUI.AddTask(task.spawn(function()
        while GUI.MainFrame and GUI.MainFrame.Parent do
            Tween(MainStroke, {Transparency = 0.1}, 2, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut)
            task.wait(2)
            if not GUI.MainFrame or not GUI.MainFrame.Parent then break end
            Tween(MainStroke, {Transparency = 0.5}, 2, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut)
            task.wait(2)
        end
    end))
    
    -- Controls Bar
    local ControlsBar = Instance.new("Frame")
    ControlsBar.Name = "ControlsBar"
    ControlsBar.Size = UDim2.new(1, 0, 0, controlBarHeight)
    ControlsBar.BackgroundColor3 = GUI.Colors.Surface
    ControlsBar.BorderSizePixel = 0
    ControlsBar.ZIndex = GUI.ZLayers.Controls
    ControlsBar.Parent = GUI.MainFrame
    
    local ControlsCorner = Instance.new("UICorner")
    ControlsCorner.CornerRadius = UDim.new(0, cornerRadius)
    ControlsCorner.Parent = ControlsBar
    
    local ControlsMask = Instance.new("Frame")
    ControlsMask.Size = UDim2.new(1, 0, 0, cornerRadius + 5)
    ControlsMask.Position = UDim2.new(0, 0, 1, -(cornerRadius + 5))
    ControlsMask.BackgroundColor3 = GUI.Colors.Surface
    ControlsMask.BorderSizePixel = 0
    ControlsMask.ZIndex = GUI.ZLayers.Controls
    ControlsMask.Parent = ControlsBar
    
    -- Control Buttons
    local buttonSize = GetResponsiveValue(14, 11, 12)
    local buttonSpacing = GetResponsiveValue(22, 18, 20)
    local buttonStartX = GetResponsiveValue(16, 12, 14)
    
    local function CreateControlButton(color, position, onClick)
        local btn = Instance.new("TextButton")
        btn.Size = UDim2.new(0, buttonSize, 0, buttonSize)
        btn.Position = UDim2.new(0, buttonStartX + (position * buttonSpacing), 0.5, -buttonSize/2)
        btn.BackgroundColor3 = color
        btn.BorderSizePixel = 0
        btn.Text = ""
        btn.AutoButtonColor = false
        btn.ZIndex = GUI.ZLayers.Controls + 1
        btn.Parent = ControlsBar
        
        local corner = Instance.new("UICorner")
        corner.CornerRadius = UDim.new(1, 0)
        corner.Parent = btn
        
        local stroke = Instance.new("UIStroke")
        stroke.Color = Color3.fromRGB(255, 255, 255)
        stroke.Thickness = 1
        stroke.Transparency = 0.8
        stroke.Parent = btn
        
        btn.MouseEnter:Connect(function()
            Tween(btn, {Size = UDim2.new(0, buttonSize + 3, 0, buttonSize + 3)}, 0.15)
            Tween(stroke, {Transparency = 0.3}, 0.15)
        end)
        
        btn.MouseLeave:Connect(function()
            Tween(btn, {Size = UDim2.new(0, buttonSize, 0, buttonSize)}, 0.15)
            Tween(stroke, {Transparency = 0.8}, 0.15)
        end)
        
        btn.MouseButton1Click:Connect(onClick)
        
        return btn
    end
    
    -- Close button
    CreateControlButton(Color3.fromRGB(255, 95, 86), 0, function()
        GUI.Cleanup()
        if getgenv()._SkibidiShuttingDown ~= nil then
            getgenv()._SkibidiShuttingDown = true
        end
    end)
    
    -- Pause button
    CreateControlButton(Color3.fromRGB(255, 189, 46), 1, function()
        GUI.IsPaused = not GUI.IsPaused
        
        if GUI.IsPaused then
            if getgenv().AutoFarmEnabled ~= nil then
                getgenv().AutoFarmEnabled = false
            end
            if GUIVars.StateValue then
                GUIVars.StateValue.Text = "PAUSED"
                GUIVars.StateValue.TextColor3 = GUI.Colors.Warning
            end
        else
            if getgenv().AutoFarmEnabled ~= nil then
                getgenv().AutoFarmEnabled = true
            end
            if GUIVars.StateValue then
                GUIVars.StateValue.TextColor3 = GUI.Colors.Text
            end
        end
    end)
    
    -- Minimize button
    local minWidth = GetResponsiveValue(240, 180, 210)
    CreateControlButton(Color3.fromRGB(39, 201, 63), 2, function()
        GUI.IsMinimized = not GUI.IsMinimized
        
        if GUI.IsMinimized then
            Tween(GUI.MainFrame, {Size = UDim2.new(0, minWidth, 0, controlBarHeight)}, 0.4, Enum.EasingStyle.Quart)
        else
            Tween(GUI.MainFrame, {Size = UDim2.new(0, panelWidth, 0, panelHeight)}, 0.4, Enum.EasingStyle.Quart)
        end
    end)
    
    -- Title
    local titleSize = GetResponsiveValue(15, 11, 13)
    local TitleLabel = Instance.new("TextLabel")
    TitleLabel.Text = "SKIBIDI v8.0"
    TitleLabel.Size = UDim2.new(1, -120, 1, 0)
    TitleLabel.Position = UDim2.new(0, buttonStartX + (3 * buttonSpacing) + 10, 0, 0)
    TitleLabel.BackgroundTransparency = 1
    TitleLabel.Font = Enum.Font.GothamBold
    TitleLabel.TextSize = titleSize
    TitleLabel.TextColor3 = GUI.Colors.Text
    TitleLabel.TextXAlignment = Enum.TextXAlignment.Left
    TitleLabel.ZIndex = GUI.ZLayers.Controls + 1
    TitleLabel.Parent = ControlsBar
    
    -- Content Area
    local ContentArea = Instance.new("Frame")
    ContentArea.Size = UDim2.new(1, 0, 1, -controlBarHeight)
    ContentArea.Position = UDim2.new(0, 0, 0, controlBarHeight)
    ContentArea.BackgroundTransparency = 1
    ContentArea.BorderSizePixel = 0
    ContentArea.ZIndex = GUI.ZLayers.MainGUI
    ContentArea.Parent = GUI.MainFrame
    
    -- Header
    local headerHeight = GetResponsiveValue(100, 80, 90)
    local Header = Instance.new("Frame")
    Header.Size = UDim2.new(1, 0, 0, headerHeight)
    Header.BackgroundTransparency = 1
    Header.ZIndex = GUI.ZLayers.MainGUI
    Header.Parent = ContentArea
    
    local headerTitleSize = GetResponsiveValue(28, 20, 24)
    local headerPadding = GetResponsiveValue(30, 20, 25)
    
    local HeaderTitle = Instance.new("TextLabel")
    HeaderTitle.Text = "CONTROL PANEL"
    HeaderTitle.Size = UDim2.new(1, -headerPadding * 2, 0, headerTitleSize + 12)
    HeaderTitle.Position = UDim2.new(0, headerPadding, 0, 20)
    HeaderTitle.BackgroundTransparency = 1
    HeaderTitle.Font = Enum.Font.GothamBold
    HeaderTitle.TextColor3 = GUI.Colors.Text
    HeaderTitle.TextSize = headerTitleSize
    HeaderTitle.TextXAlignment = Enum.TextXAlignment.Left
    HeaderTitle.ZIndex = GUI.ZLayers.MainGUI + 1
    HeaderTitle.Parent = Header
    
    local subtitleSize = GetResponsiveValue(13, 10, 11)
    local Subtitle = Instance.new("TextLabel")
    Subtitle.Text = "Ultimate Edition • Persistent Storage"
    Subtitle.Size = UDim2.new(1, -headerPadding * 2, 0, subtitleSize + 8)
    Subtitle.Position = UDim2.new(0, headerPadding, 0, headerTitleSize + 35)
    Subtitle.BackgroundTransparency = 1
    Subtitle.Font = Enum.Font.Gotham
    Subtitle.TextColor3 = GUI.Colors.Primary
    Subtitle.TextSize = subtitleSize
    Subtitle.TextXAlignment = Enum.TextXAlignment.Left
    Subtitle.ZIndex = GUI.ZLayers.MainGUI + 1
    Subtitle.Parent = Header
    
    -- Stats Container
    local statsPadding = GetResponsiveValue(30, 20, 25)
    local statsTop = headerHeight + 10
    
    local StatsContainer = Instance.new("ScrollingFrame")
    StatsContainer.Position = UDim2.new(0, statsPadding, 0, statsTop)
    StatsContainer.Size = UDim2.new(1, -statsPadding * 2, 1, -statsTop - 15)
    StatsContainer.BackgroundTransparency = 1
    StatsContainer.BorderSizePixel = 0
    StatsContainer.ScrollBarThickness = 5
    StatsContainer.ScrollBarImageColor3 = GUI.Colors.Primary
    StatsContainer.CanvasSize = UDim2.new(0, 0, 0, 0)
    StatsContainer.AutomaticCanvasSize = Enum.AutomaticSize.Y
    StatsContainer.ZIndex = GUI.ZLayers.MainGUI
    StatsContainer.Parent = ContentArea
    
    local StatsLayout = Instance.new("UIListLayout")
    StatsLayout.SortOrder = Enum.SortOrder.LayoutOrder
    StatsLayout.Padding = UDim.new(0, GetResponsiveValue(16, 10, 13))
    StatsLayout.Parent = StatsContainer
    
    -- Create Stat Card Function
    local function CreateStatCard(label, value, iconType, order)
        local cardHeight = GetResponsiveValue(90, 68, 78)
        
        local Card = Instance.new("Frame")
        Card.Size = UDim2.new(1, 0, 0, cardHeight)
        Card.BackgroundColor3 = GUI.Colors.SurfaceLight
        Card.BorderSizePixel = 0
        Card.LayoutOrder = order
        Card.ZIndex = GUI.ZLayers.MainGUI + 1
        Card.Parent = StatsContainer
        
        local CardCorner = Instance.new("UICorner")
        CardCorner.CornerRadius = UDim.new(0, GetResponsiveValue(16, 12, 14))
        CardCorner.Parent = Card
        
        local CardStroke = Instance.new("UIStroke")
        CardStroke.Color = GUI.Colors.Border
        CardStroke.Thickness = 1.5
        CardStroke.Transparency = 0.6
        CardStroke.Parent = Card
        
        -- Icon Container
        local iconContainerSize = GetResponsiveValue(65, 50, 57)
        local iconContainerX = GetResponsiveValue(20, 14, 17)
        
        local IconContainer = Instance.new("Frame")
        IconContainer.Size = UDim2.new(0, iconContainerSize, 0, iconContainerSize)
        IconContainer.Position = UDim2.new(0, iconContainerX, 0.5, -iconContainerSize/2)
        IconContainer.BackgroundColor3 = GUI.Colors.Surface
        IconContainer.BorderSizePixel = 0
        IconContainer.ZIndex = GUI.ZLayers.MainGUI + 2
        IconContainer.Parent = Card
        
        local IconCorner = Instance.new("UICorner")
        IconCorner.CornerRadius = UDim.new(0, GetResponsiveValue(16, 12, 14))
        IconCorner.Parent = IconContainer
        
        local IconStroke = Instance.new("UIStroke")
        IconStroke.Color = GUI.Colors.Primary
        IconStroke.Thickness = 2
        IconStroke.Transparency = 0.5
        IconStroke.Parent = IconContainer
        
        -- Icon
        local iconSize = GetResponsiveValue(34, 26, 30)
        local Icon = Icons.Create(IconContainer, iconType, iconSize, GUI.Colors.Primary)
        Icon.Position = UDim2.new(0.5, -iconSize/2, 0.5, -iconSize/2)
        Icon.ZIndex = GUI.ZLayers.MainGUI + 3
        
        -- Text
        local labelX = iconContainerX + iconContainerSize + GetResponsiveValue(18, 12, 15)
        local labelSize = GetResponsiveValue(12, 9, 10)
        
        local Label = Instance.new("TextLabel")
        Label.Text = label
        Label.Size = UDim2.new(1, -labelX - 10, 0, labelSize + 10)
        Label.Position = UDim2.new(0, labelX, 0, cardHeight * 0.25)
        Label.BackgroundTransparency = 1
        Label.Font = Enum.Font.GothamMedium
        Label.TextSize = labelSize
        Label.TextColor3 = GUI.Colors.TextMuted
        Label.TextXAlignment = Enum.TextXAlignment.Left
        Label.ZIndex = GUI.ZLayers.MainGUI + 2
        Label.Parent = Card
        
        local valueSize = GetResponsiveValue(28, 18, 22)
        
        local Value = Instance.new("TextLabel")
        Value.Text = value
        Value.Size = UDim2.new(1, -labelX - 10, 0, valueSize + 8)
        Value.Position = UDim2.new(0, labelX, 0, cardHeight * 0.55)
        Value.BackgroundTransparency = 1
        Value.Font = Enum.Font.GothamBold
        Value.TextSize = valueSize
        Value.TextColor3 = GUI.Colors.Text
        Value.TextXAlignment = Enum.TextXAlignment.Left
        Value.TextTruncate = Enum.TextTruncate.AtEnd
        Value.ZIndex = GUI.ZLayers.MainGUI + 2
        Value.Parent = Card
        
        -- Hover effects
        local hoverConnection = Card.MouseEnter:Connect(function()
            Tween(CardStroke, {Transparency = 0.2, Color = GUI.Colors.Primary}, 0.2)
            Tween(IconStroke, {Transparency = 0.1}, 0.2)
            Tween(Card, {BackgroundColor3 = GUI.Colors.Surface}, 0.2)
        end)
        GUI.AddConnection(hoverConnection)
        
        local leaveConnection = Card.MouseLeave:Connect(function()
            Tween(CardStroke, {Transparency = 0.6, Color = GUI.Colors.Border}, 0.2)
            Tween(IconStroke, {Transparency = 0.5}, 0.2)
            Tween(Card, {BackgroundColor3 = GUI.Colors.SurfaceLight}, 0.2)
        end)
        GUI.AddConnection(leaveConnection)
        
        task.wait(order * 0.04)
        
        return Value
    end
    
    -- Load persistent data
    local stats = PersistentStorage:GetStats()
    
    -- Create stat cards
    GUIVars.TargetValue = CreateStatCard("TARGET", "Searching...", "target", 1)
    GUIVars.StateValue = CreateStatCard("STATUS", "Initializing", "status", 2)
    GUIVars.BountyValue = CreateStatCard("SESSION BOUNTY", "+" .. tostring(stats.session_bounty), "bounty", 3)
    GUIVars.TimeValue = CreateStatCard("SESSION TIME", "0:00", "time", 4)
    
    getgenv().GUIVars = GUIVars
    
    -- Dragging functionality
    local dragging, dragInput, dragStart, startPos
    
    local dragBeganConnection = ControlsBar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or
           input.UserInputType == Enum.UserInputType.Touch then
            if GUI.IsMinimized then return end
            
            dragging = true
            dragStart = input.Position
            startPos = GUI.MainFrame.Position
            
            local endConnection
            endConnection = input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                    if endConnection then
                        endConnection:Disconnect()
                    end
                end
            end)
        end
    end)
    GUI.AddConnection(dragBeganConnection)
    
    local dragChangedConnection = ControlsBar.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or
           input.UserInputType == Enum.UserInputType.Touch then
            dragInput = input
        end
    end)
    GUI.AddConnection(dragChangedConnection)
    
    local inputChangedConnection = UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging and GUI.MainFrame and GUI.MainFrame.Parent then
            local delta = input.Position - dragStart
            GUI.MainFrame.Position = UDim2.new(
                startPos.X.Scale,
                startPos.X.Offset + delta.X,
                startPos.Y.Scale,
                startPos.Y.Offset + delta.Y
            )
        end
    end)
    GUI.AddConnection(inputChangedConnection)
    
    -- Entrance animation
    Tween(GUI.MainFrame, {Size = UDim2.new(0, panelWidth, 0, panelHeight)}, 0.8, Enum.EasingStyle.Back, Enum.EasingDirection.Out)
    
    -- Initialize assets
    task.spawn(function()
        GUI.InitAssets()
    end)
    
    -- Logger
    local Logger = {}
    
    function Logger:Log(m)
        if GUIVars.StateValue and GUIVars.StateValue.Parent then
            GUIVars.StateValue.Text = tostring(m)
        end
    end
    
    function Logger:Info(m) self:Log(m) end
    function Logger:Success(m) self:Log(m) end
    function Logger:Warning(m) self:Log(m) end
    function Logger:Error(m) self:Log(m) end
    
    function Logger:Target(m)
        if GUIVars.TargetValue and GUIVars.TargetValue.Parent then
            GUIVars.TargetValue.Text = tostring(m)
        end
    end
    
    return Logger
end

-- ============================================
-- SERVER CHANGE SCREEN
-- ============================================

function GUI.ShowServerChangeScreen()
    if not GUI.SkibidiGui then return end
    
    local Screen = Instance.new("Frame")
    Screen.Name = "ServerHopScreen"
    Screen.Size = UDim2.new(1, 0, 1, 0)
    Screen.BackgroundColor3 = GUI.Colors.Background
    Screen.BackgroundTransparency = 0
    Screen.ZIndex = GUI.ZLayers.ServerChange
    Screen.Parent = GUI.SkibidiGui
    
    -- Try to load video background
    if GUI.Config.VideoBackgrounds then
        local VideoBg = Instance.new("VideoFrame")
        VideoBg.Size = UDim2.new(1, 0, 1, 0)
        VideoBg.BackgroundTransparency = 1
        VideoBg.Looped = true
        VideoBg.Volume = 0
        VideoBg.ZIndex = GUI.ZLayers.ServerChange + 1
        VideoBg.Parent = Screen
        
        local videoPath = ASSETS_FOLDER .. "/change.webm"
        if isfile and isfile(videoPath) then
            AssetDownloader:LoadAsset(videoPath, VideoBg)
            VideoBg:Play()
        end
    end
    
    local Overlay = Instance.new("Frame")
    Overlay.Size = UDim2.new(1, 0, 1, 0)
    Overlay.BackgroundColor3 = GUI.Colors.Overlay
    Overlay.BackgroundTransparency = 0.3
    Overlay.BorderSizePixel = 0
    Overlay.ZIndex = GUI.ZLayers.ServerChange + 2
    Overlay.Parent = Screen
    
    -- Content
    local containerWidth = GetResponsiveValue(550, 320, 450)
    local containerHeight = GetResponsiveValue(200, 160, 180)
    
    local Container = Instance.new("Frame")
    Container.Size = UDim2.new(0, containerWidth, 0, containerHeight)
    Container.Position = UDim2.new(0.5, -containerWidth/2, 0.5, -containerHeight/2)
    Container.BackgroundTransparency = 1
    Container.ZIndex = GUI.ZLayers.ServerChange + 3
    Container.Parent = Screen
    
    local titleSize = GetResponsiveValue(52, 34, 44)
    local Title = Instance.new("TextLabel")
    Title.Text = "CHANGING SERVER"
    Title.Size = UDim2.new(1, 0, 0, titleSize + 22)
    Title.BackgroundTransparency = 1
    Title.Font = Enum.Font.GothamBold
    Title.TextSize = titleSize
    Title.TextColor3 = GUI.Colors.Text
    Title.TextTransparency = 1
    Title.ZIndex = GUI.ZLayers.ServerChange + 4
    Title.Parent = Container
    
    local subtitleSize = GetResponsiveValue(20, 14, 17)
    local Subtitle = Instance.new("TextLabel")
    Subtitle.Text = "Finding optimal server..."
    Subtitle.Size = UDim2.new(1, 0, 0, subtitleSize + 14)
    Subtitle.Position = UDim2.new(0, 0, 0, titleSize + 32)
    Subtitle.BackgroundTransparency = 1
    Subtitle.Font = Enum.Font.Gotham
    Subtitle.TextSize = subtitleSize
    Subtitle.TextColor3 = GUI.Colors.Primary
    Subtitle.TextTransparency = 1
    Subtitle.ZIndex = GUI.ZLayers.ServerChange + 4
    Subtitle.Parent = Container
    
    -- Progress bar
    local progressY = titleSize + 80
    local ProgressBg = Instance.new("Frame")
    ProgressBg.Size = UDim2.new(1, 0, 0, 6)
    ProgressBg.Position = UDim2.new(0, 0, 0, progressY)
    ProgressBg.BackgroundColor3 = GUI.Colors.Surface
    ProgressBg.BorderSizePixel = 0
    ProgressBg.BackgroundTransparency = 1
    ProgressBg.ZIndex = GUI.ZLayers.ServerChange + 4
    ProgressBg.Parent = Container
    
    local ProgressCorner = Instance.new("UICorner")
    ProgressCorner.CornerRadius = UDim.new(1, 0)
    ProgressCorner.Parent = ProgressBg
    
    local Progress = Instance.new("Frame")
    Progress.Size = UDim2.new(0, 0, 1, 0)
    Progress.BackgroundColor3 = GUI.Colors.Primary
    Progress.BorderSizePixel = 0
    Progress.ZIndex = GUI.ZLayers.ServerChange + 5
    Progress.Parent = ProgressBg
    
    local ProgressCorner2 = Instance.new("UICorner")
    ProgressCorner2.CornerRadius = UDim.new(1, 0)
    ProgressCorner2.Parent = Progress
    
    -- Animations
    Tween(Title, {TextTransparency = 0}, 0.7)
    task.wait(0.1)
    Tween(Subtitle, {TextTransparency = 0}, 0.7)
    task.wait(0.1)
    Tween(ProgressBg, {BackgroundTransparency = 0.4}, 0.7)
    
    Tween(Progress, {Size = UDim2.new(1, 0, 1, 0)}, 3.5, Enum.EasingStyle.Linear)
end

-- ============================================
-- CLEANUP
-- ============================================

function GUI.Cleanup()
    GUI.SaveMusicState()
    
    -- Save session data before cleanup
    if getgenv().GetCurrentBounty then
        local currentBounty = getgenv().GetCurrentBounty()
        local initialBounty = getgenv().InitialBounty or 0
        local sessionGain = currentBounty - initialBounty
        local totalKills = getgenv().TotalKills or 0
        local sessionTime = math.floor(tick() - (getgenv().SessionStartTime or tick()))
        
        PersistentStorage:UpdateSession(sessionGain, totalKills, sessionTime)
    end
    
    for _, tween in ipairs(GUI.RunningTweens) do
        pcall(function() if tween then tween:Cancel() end end)
    end
    GUI.RunningTweens = {}
    
    for _, taskThread in ipairs(GUI.Tasks) do
        pcall(function() if taskThread then task.cancel(taskThread) end end)
    end
    GUI.Tasks = {}
    
    for _, connection in ipairs(GUI.Connections) do
        pcall(function()
            if connection and connection.Connected then
                connection:Disconnect()
            end
        end)
    end
    GUI.Connections = {}
    
    if GUI.MusicSound then
        pcall(function()
            GUI.MusicSound:Stop()
            GUI.MusicSound:Destroy()
        end)
        GUI.MusicSound = nil
    end
    
    if GUI._BoostScreen then
        pcall(function() GUI._BoostScreen:Destroy() end)
        GUI._BoostScreen = nil
    end
    
    if GUI.VideoBackground then
        pcall(function() GUI.VideoBackground:Destroy() end)
        GUI.VideoBackground = nil
    end
    
    if GUI.SkibidiGui then
        pcall(function() GUI.SkibidiGui:Destroy() end)
        GUI.SkibidiGui = nil
    end
    
    GUI.MainFrame = nil
end

getgenv().SkibidiGUI_v8 = GUI

return GUI
